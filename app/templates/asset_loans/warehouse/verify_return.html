{% extends "base.html" %}

{% block title %}Verifikasi Pengembalian - Smart Geo Inventory{% endblock %}

{% block page_title %}Verifikasi Pengembalian{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-4">
    <a href="{{ url_for('asset_loans.warehouse_detail', id=loan.id) }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali ke Detail
    </a>
</div>

<!-- Info Card -->
<div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
    <div class="flex items-start">
        <div class="bg-blue-100 rounded-lg p-2 mr-4">
            <i class="fas fa-clipboard-check text-blue-600 text-xl"></i>
        </div>
        <div>
            <h4 class="font-semibold text-blue-900 mb-2">Verifikasi Pengembalian</h4>
            <p class="text-sm text-blue-800">
                Periksa bukti pengembalian yang diupload oleh Unit. Jika sesuai, setujui pengembalian dan barang akan kembali tersedia di stok.
            </p>
        </div>
    </div>
</div>

<!-- Item Info -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Informasi Barang</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <span class="text-gray-600 text-sm">Nama Barang:</span>
                <p class="font-semibold">{{ loan_item.item_detail.item.name if loan_item.item_detail and loan_item.item_detail.item else '-' }}</p>
            </div>
            <div>
                <span class="text-gray-600 text-sm">Serial Number:</span>
                <p class="font-semibold"><code>{{ loan_item.item_detail.serial_number if loan_item.item_detail else '-' }}</code></p>
            </div>
            <div>
                <span class="text-gray-600 text-sm">Quantity:</span>
                <p class="font-semibold">{{ loan_item.quantity }}</p>
            </div>
            <div>
                <span class="text-gray-600 text-sm">Status:</span>
                <p class="font-semibold">
                    {% if loan_item.return_verification_status == 'verified' %}
                    <span class="text-green-600">Diverifikasi</span>
                    {% elif loan_item.return_verification_status == 'submitted' %}
                    <span class="text-blue-600">Menunggu Verifikasi</span>
                    {% elif loan_item.return_verification_status == 'rejected' %}
                    <span class="text-red-600">Ditolak</span>
                    {% else %}
                    <span class="text-gray-600">Belum</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Return Proof -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Bukti Pengembalian</h3>
    </div>
    <div class="p-6">
        {% if loan_item.return_photo %}
        <div class="mb-4">
            <img src="{{ loan_item.return_photo }}" alt="Bukti Pengembalian" class="max-w-md h-auto rounded-lg border border-gray-200">
        </div>
        <a href="{{ loan_item.return_photo }}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
            <i class="fas fa-external-link-alt mr-1"></i>Buka di tab baru
        </a>
        {% else %}
        <p class="text-gray-500">Belum ada bukti pengembalian yang diupload.</p>
        {% endif %}

        {% if loan_item.return_notes %}
        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Catatan Pengembalian</h4>
            <p class="text-gray-600">{{ loan_item.return_notes }}</p>
        </div>
        {% endif %}

        {% if loan_item.return_rejection_reason %}
        <div class="mt-4 p-4 bg-red-50 rounded-lg">
            <h4 class="text-sm font-semibold text-red-700 mb-2">Alasan Penolakan Sebelumnya</h4>
            <p class="text-red-600">{{ loan_item.return_rejection_reason }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Verify Form -->
<div class="bg-white rounded-xl shadow-md">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Verifikasi Pengembalian</h3>
    </div>
    <form method="POST" class="p-6">
        {{ form.hidden_tag() }}

        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-check-circle mr-1 text-green-600"></i>
                Aksi
            </label>
            {{ form.action(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all") }}
        </div>

        <div class="mb-6" id="rejectionReasonDiv" style="display: none;">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-comment-alt mr-1 text-red-600"></i>
                Alasan Penolakan
            </label>
            {{ form.rejection_reason(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all", rows="4", placeholder="Jelaskan alasan penolakan") }}
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
            <a href="{{ url_for('asset_loans.warehouse_detail', id=loan.id) }}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                <i class="fas fa-times mr-2"></i>
                Batal
            </a>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                <i class="fas fa-check mr-2"></i>
                Simpan
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const actionSelect = document.getElementById('action');
    const rejectionReasonDiv = document.getElementById('rejectionReasonDiv');
    const rejectionReasonInput = document.getElementById('rejection_reason');

    actionSelect.addEventListener('change', function() {
        if (this.value === 'reject') {
            rejectionReasonDiv.style.display = 'block';
            rejectionReasonInput.required = true;
        } else {
            rejectionReasonDiv.style.display = 'none';
            rejectionReasonInput.required = false;
        }
    });

    // Check initial value
    if (actionSelect.value === 'reject') {
        rejectionReasonDiv.style.display = 'block';
        rejectionReasonInput.required = true;
    }
});
</script>
{% endblock %}
