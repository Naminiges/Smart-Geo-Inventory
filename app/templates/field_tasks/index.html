{% extends "base.html" %}

{% block title %}Tugas Saya - Smart Geo Inventory{% endblock %}

{% block page_title %}Daftar Pekerjaan{% endblock %}

{% block content %}
<!-- Header with Stats -->
<div class="mb-6">
    <div class="bg-emerald-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Daftar Pekerjaan</h1>
                <p class="mb-0 text-orange-100">
                    <i class="fas fa-clipboard-check mr-2"></i>
                    Kelola pekerjaan instalasi dan pengiriman Anda
                </p>
            </div>
            <div class="text-right">
                <i class="fas fa-clipboard-list text-6xl opacity-30"></i>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-gray-400">
        <div class="flex items-center">
            <div class="bg-gray-100 rounded-full p-2">
                <i class="fas fa-tasks text-gray-600"></i>
            </div>
            <div class="ml-3">
                <p class="text-xs text-gray-500">Semua Pekerjaan</p>
                <p class="text-xl font-bold text-gray-800">{{ total_tasks }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-amber-500">
        <div class="flex items-center">
            <div class="bg-amber-100 rounded-full p-2">
                <i class="fas fa-clock text-amber-600"></i>
            </div>
            <div class="ml-3">
                <p class="text-xs text-gray-500">Belum Dikerjakan</p>
                <p class="text-xl font-bold text-gray-800">{{ pending_tasks }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-blue-500">
        <div class="flex items-center">
            <div class="bg-blue-100 rounded-full p-2">
                <i class="fas fa-hourglass-half text-blue-600"></i>
            </div>
            <div class="ml-3">
                <p class="text-xs text-gray-500">Menunggu Dicek</p>
                <p class="text-xl font-bold text-gray-800">{{ submitted_tasks }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-green-500">
        <div class="flex items-center">
            <div class="bg-green-100 rounded-full p-2">
                <i class="fas fa-check-circle text-green-600"></i>
            </div>
            <div class="ml-3">
                <p class="text-xs text-gray-500">Selesai</p>
                <p class="text-xl font-bold text-gray-800">{{ verified_tasks }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Task Type Stats -->
<div class="grid grid-cols-2 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-purple-500">
        <div class="flex items-center">
            <div class="bg-purple-100 rounded-full p-2">
                <i class="fas fa-tools text-purple-600"></i>
            </div>
            <div class="ml-3">
                <p class="text-xs text-gray-500">Pekerjaan Pemasangan</p>
                <p class="text-xl font-bold text-gray-800">{{ installation_tasks }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-indigo-500">
        <div class="flex items-center">
            <div class="bg-indigo-100 rounded-full p-2">
                <i class="fas fa-truck text-indigo-600"></i>
            </div>
            <div class="ml-3">
                <p class="text-xs text-gray-500">Pekerjaan Pengiriman</p>
                <p class="text-xl font-bold text-gray-800">{{ delivery_tasks }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm p-4 mb-6">
    <form method="GET" class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-600 mb-1">Filter Status</label>
            <select name="status" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">Semua Status</option>
                <option value="installing" {{ 'selected' if status_filter == 'installing' }}>Sedang Dipasang</option>
                <option value="in_transit" {{ 'selected' if status_filter == 'in_transit' }}>Sedang Dikirim</option>
                <option value="installed" {{ 'selected' if status_filter == 'installed' }}>Terpasang</option>
            </select>
        </div>

        <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-600 mb-1">Jenis Pekerjaan</label>
            <select name="task_type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">Semua Jenis</option>
                <option value="installation" {{ 'selected' if task_type_filter == 'installation' }}>Pemasangan</option>
                <option value="delivery" {{ 'selected' if task_type_filter == 'delivery' }}>Pengiriman</option>
            </select>
        </div>

        <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-600 mb-1">Status Pengecekan</label>
            <select name="verification" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">Semua Pengecekan</option>
                <option value="pending" {{ 'selected' if verification_filter == 'pending' }}>Belum Dikerjakan</option>
                <option value="submitted" {{ 'selected' if verification_filter == 'submitted' }}>Menunggu Dicek</option>
                <option value="verified" {{ 'selected' if verification_filter == 'verified' }}>Sudah Dicek</option>
                <option value="rejected" {{ 'selected' if verification_filter == 'rejected' }}>Ditolak</option>
            </select>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                <i class="fas fa-filter mr-1"></i> Filter
            </button>
            <a href="{{ url_for('field_tasks.index') }}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas fa-times mr-1"></i> Reset
            </a>
        </div>
    </form>
</div>

<!-- Tasks List -->
<div class="bg-white rounded-xl shadow-md">
    <div class="p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">Daftar Pekerjaan</h2>
    </div>

    <div class="p-4">
        {% if tasks and tasks|length > 0 %}
        <div class="space-y-4">
            {% for task in tasks %}
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow {{ 'border-l-4 border-l-amber-500' if task.verification_status == 'pending' else 'border-l-4 border-l-blue-500' if task.verification_status == 'submitted' else 'border-l-4 border-l-green-500' if task.verification_status == 'verified' else 'border-l-4 border-l-red-500' }}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="font-semibold text-gray-800 text-lg">
                                {% if task.task_type == 'installation' %}
                                <i class="fas fa-tools text-purple-600"></i> Pemasangan
                                {% else %}
                                <i class="fas fa-truck text-indigo-600"></i> Pengiriman
                                {% endif %}
                            </h3>
                            <span class="px-2 py-1 text-xs rounded-full
                                {% if task.verification_status == 'pending' %}bg-amber-100 text-amber-700
                                {% elif task.verification_status == 'submitted' %}bg-blue-100 text-blue-700
                                {% elif task.verification_status == 'verified' %}bg-green-100 text-green-700
                                {% else %}bg-red-100 text-red-700{% endif %}">
                                {{ task.verification_status_display }}
                            </span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                            <p><i class="fas fa-box mr-2 text-gray-400"></i> <strong>Barang:</strong> {{ task.item_detail.item.name if task.item_detail and task.item_detail.item else '-' }}</p>
                            <p><i class="fas fa-building mr-2 text-gray-400"></i> <strong>Unit:</strong> {{ task.unit.name if task.unit else '-' }}</p>
                            <p><i class="fas fa-door-open mr-2 text-gray-400"></i> <strong>Ruangan:</strong> {{ task.unit_detail.room_name if task.unit_detail else '-' }}</p>
                            <p><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> <strong>Alamat:</strong> {{ task.address or '-' }}</p>
                            <p><i class="fas fa-calendar mr-2 text-gray-400"></i> <strong>Tanggal:</strong> {{ task.created_at.strftime('%d/%m/%Y') if task.created_at else '-' }}</p>
                            <p><i class="fas fa-info-circle mr-2 text-gray-400"></i> <strong>Status:</strong> {{ task.status_display }}</p>
                        </div>

                        {% if task.note %}
                        <p class="mt-2 text-sm text-gray-500"><i class="fas fa-sticky-note mr-2"></i> {{ task.note }}</p>
                        {% endif %}

                        {% if task.verification_status == 'rejected' and task.verification_rejection_reason %}
                        <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <strong>Alasan Ditolak:</strong> {{ task.verification_rejection_reason }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="ml-4 flex flex-col gap-2">
                        <a href="{{ url_for('field_tasks.detail', id=task.id) }}" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors text-center">
                            <i class="fas fa-eye mr-1"></i> Lihat
                        </a>
                        {% if task.verification_status == 'pending' or task.verification_status == 'rejected' %}
                        <a href="{{ url_for('field_tasks.submit_verification', id=task.id) }}" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors text-center">
                            <i class="fas fa-check mr-1"></i> Selesai
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-gray-500 py-12">
            <i class="fas fa-clipboard-list text-6xl mb-4 opacity-30"></i>
            <p class="text-lg mb-0">Tidak ada pekerjaan</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
