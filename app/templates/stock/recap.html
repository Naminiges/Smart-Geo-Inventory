{% extends "base.html" %}

{% block title %}Laporan Rekap - Smart Geo Inventory{% endblock %}

{% block page_title %}Laporan Rekap Tahunan{% endblock %}

{% block content %}
<!-- Year Selector & Print Button -->
<div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-2">
        <a href="{{ url_for('stock.recap', year=year-1) }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <i class="fas fa-chevron-left"></i>
        </a>
        <span class="text-xl font-bold text-gray-800">{{ year }}</span>
        <a href="{{ url_for('stock.recap', year=year+1) }}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <i class="fas fa-chevron-right"></i>
        </a>
    </div>
    <div class="flex gap-2">
        <button onclick="window.print()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-print mr-2"></i>Cetak Laporan
        </button>
        <a href="{{ url_for('stock.index') }}" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Kembali
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-600">
        <div class="text-center">
            <div class="text-3xl font-bold text-green-600">{{ total_in }}</div>
            <div class="text-sm text-gray-500 mt-1">Barang Masuk</div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-600">
        <div class="text-center">
            <div class="text-3xl font-bold text-red-600">{{ total_out }}</div>
            <div class="text-sm text-gray-500 mt-1">Barang Keluar</div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-600">
        <div class="text-center">
            <div class="text-3xl font-bold text-orange-600">{{ total_returned }}</div>
            <div class="text-sm text-gray-500 mt-1">Retur dari Unit</div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-600">
        <div class="text-center">
            <div class="text-3xl font-bold text-yellow-600">{{ total_obname }}</div>
            <div class="text-sm text-gray-500 mt-1">Obname (Endap di Gudang)</div>
        </div>
    </div>
</div>

<!-- Barang Masuk Dari -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center">
            <i class="fas fa-arrow-down text-green-600 text-xl mr-3"></i>
            <h5 class="text-lg font-semibold mb-0">Barang Masuk ke Gudang</h5>
        </div>
    </div>
    <div class="p-6">
        {% if in_by_source %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for source, count in in_by_source.items() %}
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="text-2xl font-bold text-green-600">{{ count }}</div>
                <div class="text-sm text-gray-600">{{ source }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-center">Tidak ada data barang masuk</p>
        {% endif %}
    </div>
</div>

<!-- Barang Keluar Ke -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center">
            <i class="fas fa-arrow-up text-red-600 text-xl mr-3"></i>
            <h5 class="text-lg font-semibold mb-0">Barang Keluar dari Gudang</h5>
        </div>
    </div>
    <div class="p-6">
        {% if out_by_source %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for source, count in out_by_source.items() %}
            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                <div class="text-2xl font-bold text-red-600">{{ count }}</div>
                <div class="text-sm text-gray-600">{{ source }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-center">Tidak ada data barang keluar</p>
        {% endif %}
    </div>
</div>

<!-- Rincian Barang Masuk -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center">
            <i class="fas fa-arrow-down text-green-600 text-xl mr-3"></i>
            <h5 class="text-lg font-semibold mb-0">Rincian Barang Masuk</h5>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if stock_in %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Gudang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Jumlah</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tanggal</th>
                </tr>
            </thead>
            <tbody>
                {% for trans in stock_in[:20] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-semibold">{{ trans.item.name }}</div>
                        <small class="text-gray-500">{{ trans.item.item_code }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">{{ trans.warehouse.name if trans.warehouse else '-' }}</td>
                    <td class="py-3 px-4 font-bold text-green-600">+{{ trans.quantity }}</td>
                    <td class="py-3 px-4 text-gray-600 text-sm">{{ trans.transaction_date.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-gray-500 text-center py-8">Tidak ada data barang masuk</p>
        {% endif %}
    </div>
</div>

<!-- Rincian Barang Keluar -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center">
            <i class="fas fa-arrow-up text-red-600 text-xl mr-3"></i>
            <h5 class="text-lg font-semibold mb-0">Rincian Barang Keluar</h5>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if stock_out or distributions %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Gudang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tujuan</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Jumlah</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tanggal</th>
                </tr>
            </thead>
            <tbody>
                {% for trans in stock_out[:20] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-semibold">{{ trans.item.name }}</div>
                        <small class="text-gray-500">{{ trans.item.item_code }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">{{ trans.warehouse.name if trans.warehouse else '-' }}</td>
                    <td class="py-3 px-4 text-gray-600">-</td>
                    <td class="py-3 px-4 font-bold text-red-600">-{{ trans.quantity }}</td>
                    <td class="py-3 px-4 text-gray-600 text-sm">{{ trans.transaction_date.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
                {% for dist in distributions[:20] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-semibold">{{ dist.item_detail.item.name }}</div>
                        <small class="text-gray-500">{{ dist.item_detail.item.item_code }}</small>
                        <small class="text-gray-500 block">SN: {{ dist.item_detail.serial_number }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">{{ dist.warehouse.name if dist.warehouse else '-' }}</td>
                    <td class="py-3 px-4 text-gray-600">
                        <div>{{ dist.unit.name if dist.unit else '-' }}</div>
                        {% if dist.unit_detail %}
                        <small class="text-gray-500">{{ dist.unit_detail.room_code }}</small>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 font-bold text-red-600">1</td>
                    <td class="py-3 px-4 text-gray-600 text-sm">{{ dist.created_at.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-gray-500 text-center py-8">Tidak ada data barang keluar</p>
        {% endif %}
    </div>
</div>

<!-- Rincian Retur -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center">
            <i class="fas fa-undo text-orange-600 text-xl mr-3"></i>
            <h5 class="text-lg font-semibold mb-0">Rincian Retur dari Unit</h5>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if returns %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Serial Number</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Unit Asal</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tanggal Retur</th>
                </tr>
            </thead>
            <tbody>
                {% for ret in returns[:20] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-semibold">{{ ret.item_detail.item.name }}</div>
                        <small class="text-gray-500">{{ ret.item_detail.item.item_code }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">{{ ret.item_detail.serial_number }}</td>
                    <td class="py-3 px-4 text-gray-600">{{ ret.unit.name if ret.unit else '-' }}</td>
                    <td class="py-3 px-4 text-gray-600 text-sm">{{ ret.created_at.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-gray-500 text-center py-8">Tidak ada data retur</p>
        {% endif %}
    </div>
</div>

<!-- Rincian Obname (Barang Endap di Gudang) -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center">
            <i class="fas fa-boxes text-yellow-600 text-xl mr-3"></i>
            <h5 class="text-lg font-semibold mb-0">Rincian Obname (Endap di Gudang)</h5>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if obname_items %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Serial Number</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Gudang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in obname_items[:50] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="font-semibold">{{ item.item.name }}</div>
                        <small class="text-gray-500">{{ item.item.item_code }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">{{ item.serial_number }}</td>
                    <td class="py-3 px-4 text-gray-600">{{ item.warehouse.name if item.warehouse else '-' }}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">Tersedia</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-gray-500 text-center py-8">Tidak ada barang yang endap di gudang</p>
        {% endif %}
    </div>
</div>

<style>
@media print {
    .no-print {
        display: none !important;
    }
    body {
        background: white !important;
    }
    .shadow-md, .shadow-lg {
        box-shadow: none !important;
    }
}
</style>
{% endblock %}
