{% extends "base.html" %}

{% block title %}Riwayat Stok - Smart Geo Inventory{% endblock %}

{% block page_title %}Riwayat Keluar Masuk{% endblock %}
{% set page_icon = 'fas fa-history' %}
{% set page_description = 'Catatan barang yang masuk dan keluar dari gudang' %}
{% block page_header_actions %}
<a href="{{ url_for('stock.recap') }}" class="px-5 py-2.5 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition-all font-semibold shadow-md hover:shadow-lg inline-flex items-center">
  <i class="fas fa-arrow-right mr-2"></i>Laporan tahunan
</a>
{% endblock %}
{% block content %}

<!-- Stock Transactions (Barang Masuk/Keluar dari Gudang) -->
<div class="bg-white rounded-xl shadow-md overflow-hidden">
    <!-- Filter Section -->
    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
        <form method="GET" class="flex flex-wrap items-center gap-4">
            <div class="flex items-center">
                <label class="text-sm font-semibold text-gray-700 mr-2">Filter:</label>

                <!-- Year Filter -->
                <select name="year" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for year in available_years %}
                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                        {{ year }}
                    </option>
                    {% endfor %}
                </select>

                <!-- Month Filter -->
                <select name="month" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ml-2">
                    <option value="" {% if not selected_month %}selected{% endif %}>Semua Bulan</option>
                    <option value="1" {% if selected_month == 1 %}selected{% endif %}>Januari</option>
                    <option value="2" {% if selected_month == 2 %}selected{% endif %}>Februari</option>
                    <option value="3" {% if selected_month == 3 %}selected{% endif %}>Maret</option>
                    <option value="4" {% if selected_month == 4 %}selected{% endif %}>April</option>
                    <option value="5" {% if selected_month == 5 %}selected{% endif %}>Mei</option>
                    <option value="6" {% if selected_month == 6 %}selected{% endif %}>Juni</option>
                    <option value="7" {% if selected_month == 7 %}selected{% endif %}>Juli</option>
                    <option value="8" {% if selected_month == 8 %}selected{% endif %}>Agustus</option>
                    <option value="9" {% if selected_month == 9 %}selected{% endif %}>September</option>
                    <option value="10" {% if selected_month == 10 %}selected{% endif %}>Oktober</option>
                    <option value="11" {% if selected_month == 11 %}selected{% endif %}>November</option>
                    <option value="12" {% if selected_month == 12 %}selected{% endif %}>Desember</option>
                </select>

                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold ml-2">
                    <i class="fas fa-filter mr-1"></i> Terapkan
                </button>

                {% if selected_year or selected_month %}
                <a href="{{ url_for('stock.index') }}" class="ml-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-semibold">
                    <i class="fas fa-times mr-1"></i> Reset
                </a>
                {% endif %}
            </div>

            <!-- Display Current Filter -->
            <div class="ml-auto text-sm text-gray-600">
                {% if selected_month %}
                <span class="font-semibold">
                    {{ ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][selected_month - 1] }} {{ selected_year }}
                </span>
                {% else %}
                <span class="font-semibold">Tahun {{ selected_year }}</span>
                {% endif %}
                <span class="text-gray-500">({{ all_entries|length }} transaksi)</span>
            </div>
        </form>
    </div>

    <div class="overflow-x-auto">
        {% if all_entries %}
        <table class="w-full paginated-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Barang</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Gudang</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jenis</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Keterangan</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for entry in all_entries[:100] %}
                    {% if entry.type == 'stock_out' %}
                        {% set trans = entry.data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-gray-600 text-sm">
                                {{ trans.transaction_date|format_wib_datetime }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-2 text-gray-500"></i>
                                    <span class="font-semibold text-gray-800">{{ trans.item.name }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-warehouse mr-2 text-gray-500"></i>
                                    <span>{{ trans.warehouse.name if trans.warehouse else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-up mr-1"></i>Keluar
                                </span>
                            </td>
                            <td class="px-6 py-4 font-bold text-red-600">-{{ trans.quantity }}</td>
                            <td class="px-6 py-4">
                                <span class="text-gray-500 text-sm">{{ trans.note or '-' }}</span>
                            </td>
                        </tr>
                    {% elif entry.type == 'return_batch' %}
                        {% set batch, item = entry.data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-gray-600 text-sm">
                                {{ batch.confirmed_at|format_wib_datetime if batch.confirmed_at else batch.created_at|format_wib_datetime }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-2 text-gray-500"></i>
                                    <span class="font-semibold text-gray-800">{{ item.item_detail.item.name if item.item_detail and item.item_detail.item else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-warehouse mr-2 text-gray-500"></i>
                                    <span>{{ batch.warehouse.name if batch.warehouse else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-down mr-1"></i>Masuk (Kembali)
                                </span>
                            </td>
                            <td class="px-6 py-4 font-bold text-green-600">+1</td>
                            <td class="px-6 py-4">
                                <a href="{{ url_for('returns.detail', id=batch.id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold inline-flex items-center">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                            </td>
                        </tr>
                    {% elif entry.type == 'procurement' %}
                        {% set proc, item = entry.data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-gray-600 text-sm">
                                {{ proc.completion_date|format_wib_datetime if proc.completion_date else proc.created_at|format_wib_datetime }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-2 text-gray-500"></i>
                                    <span class="font-semibold text-gray-800">{{ item.item.name if item.item else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-warehouse mr-2 text-gray-500"></i>
                                    <span>{{ proc.warehouse.name if proc.warehouse else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-down mr-1"></i>Masuk (Baru)
                                </span>
                            </td>
                            <td class="px-6 py-4 font-bold text-green-600">+{{ item.quantity }}</td>
                            <td class="px-6 py-4">
                                <a href="{{ url_for('procurement.detail', id=proc.id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold inline-flex items-center">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                            </td>
                        </tr>
                    {% elif entry.type == 'distribution_group' %}
                        {% set group, dist = entry.data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-gray-600 text-sm">
                                {{ group.verified_at|format_wib_datetime if group.verified_at else group.created_at|format_wib_datetime }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-2 text-gray-500"></i>
                                    <span class="font-semibold text-gray-800">{{ dist.item_detail.item.name if dist.item_detail and dist.item_detail.item else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-warehouse mr-2 text-gray-500"></i>
                                    <span>{{ group.warehouse.name if group.warehouse else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-up mr-1"></i>Keluar (Kirim)
                                </span>
                            </td>
                            <td class="px-6 py-4 font-bold text-red-600">-1</td>
                            <td class="px-6 py-4">
                                <a href="{{ url_for('installations.batch_detail', id=dist.id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold inline-flex items-center">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                            </td>
                        </tr>
                    {% elif entry.type == 'direct_distribution' %}
                        {% set dist = entry.data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-gray-600 text-sm">
                                {{ dist.created_at|format_wib_datetime }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-2 text-gray-500"></i>
                                    <span class="font-semibold text-gray-800">{{ dist.item_detail.item.name if dist.item_detail else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-warehouse mr-2 text-gray-500"></i>
                                    <span>{{ dist.warehouse.name if dist.warehouse else '-' }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-up mr-1"></i>Keluar (Permintaan)
                                </span>
                            </td>
                            <td class="px-6 py-4 font-bold text-red-600">-1</td>
                            <td class="px-6 py-4">
                                {% if dist.asset_request_id %}
                                <a href="{{ url_for('asset_requests.detail', id=dist.asset_request_id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold inline-flex items-center">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                                {% else %}
                                <span class="text-gray-500 text-sm">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-inbox text-gray-400 text-5xl mb-4"></i>
            <p class="text-gray-600 font-semibold">Belum ada transaksi stok</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
