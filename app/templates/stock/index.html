{% extends "base.html" %}

{% block title %}Riwayat Stok - Smart Geo Inventory{% endblock %}

{% block page_title %}Riwayat Barang Masuk & Keluar{% endblock %}

{% block content %}
<!-- Navigation Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <a href="{{ url_for('stock.recap') }}" class="bg-emerald-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all p-6 block">
        <div class="flex items-center justify-between">
            <div>
                <h5 class="text-lg font-semibold mb-1"><i class="fas fa-chart-line mr-2"></i>Laporan Rekap</h5>
                <p class="text-sm opacity-90">Laporan tahunan barang masuk, keluar, dan sisa</p>
            </div>
            <i class="fas fa-arrow-right text-2xl opacity-70"></i>
        </div>
    </a>

    <a href="{{ url_for('stock.per_unit') }}" class="bg-emerald-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all p-6 block">
        <div class="flex items-center justify-between">
            <div>
                <h5 class="text-lg font-semibold mb-1"><i class="fas fa-building mr-2"></i>Stok Per Unit</h5>
                <p class="text-sm opacity-90">Lihat stok barang di setiap unit dan ruangan</p>
            </div>
            <i class="fas fa-arrow-right text-2xl opacity-70"></i>
        </div>
    </a>

    <a href="{{ url_for('stock.transactions') }}" class="bg-emerald-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all p-6 block">
        <div class="flex items-center justify-between">
            <div>
                <h5 class="text-lg font-semibold mb-1"><i class="fas fa-history mr-2"></i>Riwayat Transaksi</h5>
                <p class="text-sm opacity-90">Lihat semua riwayat transaksi stok</p>
            </div>
            <i class="fas fa-arrow-right text-2xl opacity-70"></i>
        </div>
    </a>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-600">
        <div class="flex items-center">
            <div class="bg-blue-100 rounded-full p-3">
                <i class="fas fa-arrow-down text-blue-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-bold text-gray-800">{{ transactions|length }}</div>
                <div class="text-sm text-gray-500">Transaksi Stok</div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-600">
        <div class="flex items-center">
            <div class="bg-green-100 rounded-full p-3">
                <i class="fas fa-truck text-green-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-bold text-gray-800">{{ distributions|length }}</div>
                <div class="text-sm text-gray-500">Distribusi ke Unit</div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-600">
        <div class="flex items-center">
            <div class="bg-orange-100 rounded-full p-3">
                <i class="fas fa-undo text-orange-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <div class="text-2xl font-bold text-gray-800">{{ returns|length }}</div>
                <div class="text-sm text-gray-500">Retur dari Unit</div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Transactions (Barang Masuk/Keluar dari Gudang) -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-exchange-alt text-blue-600 text-xl mr-3"></i>
                <div>
                    <h5 class="text-lg font-semibold mb-0">Transaksi Stok Gudang</h5>
                    <small class="text-gray-500">Barang masuk dan keluar dari gudang</small>
                </div>
            </div>
            <a href="{{ url_for('stock.transactions') }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if transactions and transactions|length > 0 %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Waktu</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Gudang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tipe</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Jumlah</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Catatan</th>
                </tr>
            </thead>
            <tbody>
                {% for trans in transactions[:10] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-gray-600 text-sm">
                        {{ trans.transaction_date.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="py-3 px-4">
                        <div class="font-semibold text-gray-800">{{ trans.item.name }}</div>
                        <small class="text-gray-500">{{ trans.item.item_code }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">{{ trans.warehouse.name if trans.warehouse else '-' }}</td>
                    <td class="py-3 px-4">
                        {% if trans.transaction_type == 'IN' %}
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                            <i class="fas fa-arrow-down mr-1"></i>Masuk
                        </span>
                        {% else %}
                        <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                            <i class="fas fa-arrow-up mr-1"></i>Keluar
                        </span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 font-bold {{ 'text-green-600' if trans.transaction_type == 'IN' else 'text-red-600' }}">
                        {{ '+' if trans.transaction_type == 'IN' else '-' }}{{ trans.quantity }}
                    </td>
                    <td class="py-3 px-4 text-gray-500 text-sm">{{ trans.note or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
            <p>Belum ada transaksi stok</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Distributions to Units (Barang Keluar ke Unit) -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-truck text-green-600 text-xl mr-3"></i>
                <div>
                    <h5 class="text-lg font-semibold mb-0">Distribusi ke Unit</h5>
                    <small class="text-gray-500">Barang yang dikirim ke unit/ruangan</small>
                </div>
            </div>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if distributions and distributions|length > 0 %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Waktu</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tujuan</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for dist in distributions[:10] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-gray-600 text-sm">
                        {{ dist.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="py-3 px-4">
                        <div class="font-semibold text-gray-800">{{ dist.item_detail.item.name if dist.item_detail else '-' }}</div>
                        <small class="text-gray-500">{{ dist.item_detail.item.item_code if dist.item_detail else '' }}</small>
                    </td>
                    <td class="py-3 px-4 text-gray-600">
                        {% if dist.unit %}
                        <span class="font-semibold">{{ dist.unit.name }}</span>
                        {% if dist.unit_detail %}
                        <small class="text-gray-500"> - {{ dist.unit_detail.room_name }}</small>
                        {% endif %}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="py-3 px-4">
                        {% if dist.item_detail.status == 'used' %}
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Terpakai</span>
                        {% elif dist.item_detail.status == 'loaned' %}
                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">Dipinjam</span>
                        {% else %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-semibold">{{ dist.item_detail.status }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-truck text-4xl mb-3 opacity-30"></i>
            <p>Belum ada distribusi barang</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Returns from Units (Barang Kembali dari Unit) -->
<div class="bg-white rounded-xl shadow-md">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-undo text-orange-600 text-xl mr-3"></i>
                <div>
                    <h5 class="text-lg font-semibold mb-0">Retur dari Unit</h5>
                    <small class="text-gray-500">Barang yang dikembalikan dari unit</small>
                </div>
            </div>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if returns and returns|length > 0 %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Waktu</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Kondisi</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Batch</th>
                </tr>
            </thead>
            <tbody>
                {% for ret in returns[:10] %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4 text-gray-600 text-sm">
                        {{ ret.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </td>
                    <td class="py-3 px-4">
                        <div class="font-semibold text-gray-800">{{ ret.item_detail.item.name if ret.item_detail else '-' }}</div>
                        <small class="text-gray-500">{{ ret.item_detail.item.item_code if ret.item_detail else '' }}</small>
                    </td>
                    <td class="py-3 px-4">
                        {% if ret.condition == 'good' %}
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Baik</span>
                        {% elif ret.condition == 'damaged' %}
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-semibold">Rusak Ringan</span>
                        {% elif ret.condition == 'broken' %}
                        <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">Rusak Berat</span>
                        {% elif ret.condition == 'missing_parts' %}
                        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold">Hilang Komponen</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 text-gray-600">#{{ ret.return_batch_id if ret.return_batch else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-undo text-4xl mb-3 opacity-30"></i>
            <p>Belum ada retur barang</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
