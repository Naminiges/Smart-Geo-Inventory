{% extends "base.html" %}

{% block title %}Transaksi Stok Gudang - Smart Geo Inventory{% endblock %}

{% block page_title %}Transaksi Stok Gudang{% endblock %}

{% block content %}
<!-- Navigation Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <a href="{{ url_for('stock.recap') }}" class="bg-emerald-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all p-6 block">
        <div class="flex items-center justify-between">
            <div>
                <h5 class="text-lg font-semibold mb-1"><i class="fas fa-chart-line mr-2"></i>Laporan Rekap</h5>
                <p class="text-sm opacity-90">Laporan tahunan barang masuk, keluar, dan sisa</p>
            </div>
            <i class="fas fa-arrow-right text-2xl opacity-70"></i>
        </div>
    </a>

    <a href="{{ url_for('stock.per_unit') }}" class="bg-emerald-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all p-6 block">
        <div class="flex items-center justify-between">
            <div>
                <h5 class="text-lg font-semibold mb-1"><i class="fas fa-building mr-2"></i>Stok Per Unit</h5>
                <p class="text-sm opacity-90">Lihat stok barang di setiap unit dan ruangan</p>
            </div>
            <i class="fas fa-arrow-right text-2xl opacity-70"></i>
        </div>
    </a>
</div>

<!-- Stock Transactions (Barang Masuk/Keluar dari Gudang) -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-exchange-alt text-blue-600 text-xl mr-3"></i>
                <div>
                    <h5 class="text-lg font-semibold mb-0">Transaksi Stok Gudang</h5>
                    <small class="text-gray-500">Barang masuk dan keluar dari gudang</small>
                </div>
            </div>
            <a href="{{ url_for('stock.transactions') }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
    </div>
    <div class="p-6 overflow-x-auto">
        {% if all_entries %}
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Waktu</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Barang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Gudang</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Tipe</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Jumlah</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in all_entries[:100] %}
                    {% if entry.type == 'stock_out' %}
                        {% set trans = entry.data %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 text-sm">
                                {{ trans.transaction_date.strftime('%d/%m/%Y %H:%M') }}
                            </td>
                            <td class="py-3 px-4">
                                <div class="font-semibold text-gray-800">{{ trans.item.name }}</div>
                                <small class="text-gray-500">Kode barang : {{ trans.item.item_code }}</small>
                            </td>
                            <td class="py-3 px-4 text-gray-600">{{ trans.warehouse.name if trans.warehouse else '-' }}</td>
                            <td class="py-3 px-4">
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-up mr-1"></i>Keluar
                                </span>
                            </td>
                            <td class="py-3 px-4 font-bold text-red-600">-{{ trans.quantity }}</td>
                            <td class="py-3 px-4">
                                <span class="text-gray-500 text-sm">{{ trans.note or '-' }}</span>
                            </td>
                        </tr>
                    {% elif entry.type == 'return_batch' %}
                        {% set batch, item = entry.data %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 text-sm">
                                {{ batch.confirmed_at.strftime('%d/%m/%Y %H:%M') if batch.confirmed_at else batch.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </td>
                            <td class="py-3 px-4">
                                <div class="font-semibold text-gray-800">{{ item.item_detail.item.name if item.item_detail and item.item_detail.item else '-' }}</div>
                                <small class="text-gray-500">Serial Unit : {{ item.item_detail.serial_unit if item.item_detail else '' }}</small>
                            </td>
                            <td class="py-3 px-4 text-gray-600">{{ batch.warehouse.name if batch.warehouse else '-' }}</td>
                            <td class="py-3 px-4">
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-down mr-1"></i>Masuk (Retur)
                                </span>
                            </td>
                            <td class="py-3 px-4 font-bold text-green-600">+1</td>
                            <td class="py-3 px-4">
                                <a href="{{ url_for('returns.detail', id=batch.id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                            </td>
                        </tr>
                    {% elif entry.type == 'procurement' %}
                        {% set proc, item = entry.data %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 text-sm">
                                {{ proc.completion_date.strftime('%d/%m/%Y %H:%M') if proc.completion_date else proc.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </td>
                            <td class="py-3 px-4">
                                <div class="font-semibold text-gray-800">{{ item.item.name if item.item else '-' }}</div>
                                <small class="text-gray-500">Kode barang : {{ item.item.item_code if item.item else '' }}</small>
                            </td>
                            <td class="py-3 px-4 text-gray-600">{{ proc.warehouse.name if proc.warehouse else '-' }}</td>
                            <td class="py-3 px-4">
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-down mr-1"></i>Masuk (Pengadaan)
                                </span>
                            </td>
                            <td class="py-3 px-4 font-bold text-green-600">+{{ item.quantity }}</td>
                            <td class="py-3 px-4">
                                <a href="{{ url_for('procurement.detail', id=proc.id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                            </td>
                        </tr>
                    {% elif entry.type == 'distribution_group' %}
                        {% set group, dist = entry.data %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 text-sm">
                                {{ group.verified_at.strftime('%d/%m/%Y %H:%M') if group.verified_at else group.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </td>
                            <td class="py-3 px-4">
                                <div class="font-semibold text-gray-800">{{ dist.item_detail.item.name if dist.item_detail and dist.item_detail.item else '-' }}</div>
                                <small class="text-gray-500">Serial Unit : {{ dist.item_detail.serial_unit if dist.item_detail else '' }}</small>
                            </td>
                            <td class="py-3 px-4 text-gray-600">{{ group.warehouse.name if group.warehouse else '-' }}</td>
                            <td class="py-3 px-4">
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-up mr-1"></i>Keluar (Langsung)
                                </span>
                            </td>
                            <td class="py-3 px-4 font-bold text-red-600">-1</td>
                            <td class="py-3 px-4">
                                <a href="{{ url_for('installations.batch_detail', id=dist.id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                            </td>
                        </tr>
                    {% elif entry.type == 'direct_distribution' %}
                        {% set dist = entry.data %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 text-gray-600 text-sm">
                                {{ dist.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </td>
                            <td class="py-3 px-4">
                                <div class="font-semibold text-gray-800">{{ dist.item_detail.item.name if dist.item_detail else '-' }}</div>
                                <small class="text-gray-500">Serial Unit : {{ dist.item_detail.serial_unit if dist.item_detail else '' }}</small>
                            </td>
                            <td class="py-3 px-4 text-gray-600">{{ dist.warehouse.name if dist.warehouse else '-' }}</td>
                            <td class="py-3 px-4">
                                <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                    <i class="fas fa-arrow-up mr-1"></i>Keluar (Permohonan)
                                </span>
                            </td>
                            <td class="py-3 px-4 font-bold text-red-600">-1</td>
                            <td class="py-3 px-4">
                                {% if dist.asset_request_id %}
                                <a href="{{ url_for('asset_requests.detail', id=dist.asset_request_id) }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                    <i class="fas fa-eye mr-1"></i>Lihat Detail
                                </a>
                                {% else %}
                                <span class="text-gray-500 text-sm">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center text-gray-500 py-8">
            <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
            <p>Belum ada transaksi stok</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
