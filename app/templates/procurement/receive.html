{% extends "base.html" %}

{% block title %}Penerimaan Barang #{{ procurement.id }} - Smart Geo Inventory{% endblock %}

{% block page_title %}Penerimaan Barang{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-4">
    <a href="{{ url_for('procurement.detail', id=procurement.id) }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali ke Detail
    </a>
</div>

<!-- Procurement Summary -->
<div class="bg-white rounded-xl shadow-md mb-6">
    <div class="p-6 border-b border-gray-200">
        <div class="flex items-center">
            <div class="bg-green-100 rounded-lg p-3 mr-4">
                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-semibold text-gray-800 mb-1">Pengadaan #{{ procurement.id }} - Disetujui</h3>
                <p class="text-sm text-gray-500">Step 3: Input detail barang yang diterima dari supplier</p>
            </div>
            <span class="px-4 py-2 bg-green-100 text-green-700 rounded-full font-semibold">
                <i class="fas fa-check mr-1"></i> {{ 'Received' if procurement.status == 'received' else 'Approved' }}
            </span>
        </div>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Total Barang Diminta</h4>
                <p class="text-2xl font-bold text-gray-800">{{ procurement.total_quantity }} unit</p>
                <p class="text-xs text-gray-500 mt-1">{{ procurement.items|length }} jenis barang</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                <h4 class="text-sm font-semibold text-blue-600 mb-2">Sudah Diterima</h4>
                <p class="text-2xl font-bold text-blue-600">{{ procurement.total_received }} unit</p>
                {% if procurement.total_received < procurement.total_quantity %}
                <p class="text-xs text-blue-600 mt-1">({{ (procurement.total_received / procurement.total_quantity * 100)|int }}% lengkap)</p>
                {% endif %}
            </div>
            <div class="bg-amber-50 rounded-lg p-4 border-2 border-amber-200">
                <h4 class="text-sm font-semibold text-amber-600 mb-2">Sisa Barang</h4>
                <p class="text-2xl font-bold text-amber-600">{{ procurement.remaining_quantity }} unit</p>
                {% if procurement.remaining_quantity > 0 %}
                <p class="text-xs text-amber-600 mt-1">Masih perlu diterima</p>
                {% else %}
                <p class="text-xs text-green-600 mt-1">Lengkap!</p>
                {% endif %}
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mt-4">
            <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Progress Penerimaan</span>
                <span class="font-semibold {{ 'text-green-600' if procurement.is_fully_received else 'text-amber-600' }}">
                    {{ procurement.total_received }} / {{ procurement.total_quantity }} unit
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="h-3 rounded-full transition-all duration-300 {{ 'bg-green-500' if procurement.is_fully_received else 'bg-amber-500' }}"
                     style="width: {{ (procurement.total_received / procurement.total_quantity * 100)|int if procurement.total_quantity > 0 else 0 }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Goods Receipt Form -->
<div class="bg-white rounded-xl shadow-md">
    <div class="p-6 border-b border-gray-200">
        <div class="flex items-center">
            <div class="bg-blue-100 rounded-lg p-3 mr-4">
                <i class="fas fa-file-invoice text-blue-600 text-2xl"></i>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-800">Form Penerimaan Barang</h3>
                <p class="text-sm text-gray-500">Record tanda terima dan detail barang yang diterima</p>
            </div>
        </div>
    </div>

    <form method="POST" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {{ form.hidden_tag() }}

        <!-- Receipt Number -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-receipt mr-1 text-red-600"></i>
                Nomor Tanda Terima / Invoice
            </label>
            {% if procurement.receipt_number %}
            <!-- Invoice already exists - read-only -->
            <div class="w-full px-4 py-3 bg-green-50 border border-green-300 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-lock mr-2 text-green-600"></i>
                    <span class="font-mono font-semibold text-green-900">{{ procurement.receipt_number }}</span>
                    <span class="ml-3 px-2 py-1 bg-green-200 text-green-800 rounded text-xs font-semibold">
                        Invoice Terdaftar
                    </span>
                </div>
            </div>
            {{ form.receipt_number(type='hidden', value=procurement.receipt_number) }}
            <p class="mt-1 text-xs text-green-600">
                <i class="fas fa-info-circle mr-1"></i>
                Invoice sudah terdaftar. Semua penerimaan menggunakan nomor invoice yang sama.
            </p>
            {% else %}
            <!-- First time receiving - input invoice -->
            {{ form.receipt_number(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all", placeholder="Contoh: INV-2024-001 atau REC-2024-001") }}
            {% if form.receipt_number.errors %}
                {% for error in form.receipt_number.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            {% endif %}
            <p class="mt-1 text-xs text-gray-500">
                <i class="fas fa-exclamation-triangle mr-1 text-amber-600"></i>
                <strong>Perhatian:</strong> Nomor invoice akan digunakan untuk semua penerimaan barang ini. Pastikan benar.
            </p>
            {% endif %}
        </div>

        <!-- Items to Receive -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-3">
                <i class="fas fa-boxes mr-1 text-purple-600"></i>
                Detail Barang yang Diterima
            </label>

            <div class="space-y-4">
                {% for proc_item in procurement.items %}
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h5 class="text-base font-semibold text-gray-800 mb-1">
                                {{ proc_item.item.name if proc_item.item else 'Item Baru' }}
                            </h5>
                            <div class="flex items-center space-x-3 text-sm text-gray-600">
                                <span>Kode: <span class="font-mono">{{ proc_item.item.item_code if proc_item.item else 'N/A' }}</span></span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded font-semibold">
                                    Diminta: {{ proc_item.quantity }} unit
                                </span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded font-semibold">
                                    Diterima: {{ proc_item.total_received }} unit
                                </span>
                                <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded font-semibold">
                                    Sisa: {{ proc_item.remaining_quantity }} unit
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Quantity Received for this item -->
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                Jumlah Diterima (Kali Ini)
                            </label>
                            <input type="number"
                                   name="quantity_{{ proc_item.id }}"
                                   id="quantity_{{ proc_item.id }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-sm"
                                   placeholder="0"
                                   min="0"
                                   max="{{ proc_item.remaining_quantity }}"
                                   value="{% if proc_item.remaining_quantity > 0 %}{{ proc_item.remaining_quantity }}{% endif %}"
                                   onchange="updateSerialUnits({{ proc_item.id }}, '{{ proc_item.item.item_code if proc_item.item else 'N/A' }}')"
                                   {% if proc_item.remaining_quantity == 0 %}disabled{% endif %}>
                            {% if proc_item.remaining_quantity == 0 %}
                            <p class="mt-1 text-xs text-green-600">
                                <i class="fas fa-check-circle mr-1"></i>
                                Barang ini sudah lengkap
                            </p>
                            {% endif %}
                        </div>

                        <!-- Serial Numbers (berdasarkan kategori require_serial_number) -->
                        <div id="serial_number_div_{{ proc_item.id }}" style="{% if proc_item.item and proc_item.item.category and proc_item.item.category.require_serial_number %}display:block;{% else %}display:none;{% endif %}">
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                Serial Number <span class="text-red-500">*</span>
                            </label>
                            <textarea name="serial_numbers_{{ proc_item.id }}"
                                      id="serial_numbers_{{ proc_item.id }}"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all font-mono text-sm"
                                      rows="3"
                                      placeholder="Contoh:&#13;&#10;SN-001&#13;&#10;SN-002&#13;&#10;SN-003"
                                      oninput="updateSerialNumberCounter({{ proc_item.id }}, {{ proc_item.remaining_quantity }})"
                                      {% if proc_item.remaining_quantity == 0 %}disabled{% endif %}></textarea>
                            <div class="mt-1 flex items-center justify-between">
                                <p class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Wajib untuk kategori ini
                                </p>
                                <p id="sn_counter_{{ proc_item.id }}" class="text-xs font-semibold">
                                    <span id="sn_count_{{ proc_item.id }}" class="text-amber-600">0</span> / {{ proc_item.remaining_quantity }}
                                </p>
                            </div>
                            <p id="sn_warning_{{ proc_item.id }}" class="mt-1 text-xs hidden">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                <span></span>
                            </p>
                        </div>

                        <!-- Serial Units - Hidden field only -->
                        <input type="hidden" name="serial_units_{{ proc_item.id }}" id="serial_units_{{ proc_item.id }}">
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="mt-3 p-3 bg-purple-50 rounded-lg">
                <p class="text-xs text-purple-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    <strong>Petunjuk:</strong> Isi jumlah barang yang diterima untuk setiap item.
                </p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-200">
            <a href="{{ url_for('procurement.detail', id=procurement.id) }}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                <i class="fas fa-arrow-left mr-2"></i>
                Kembali
            </a>
            <button type="button" onclick="showConfirmModal()" id="submitBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
                <i class="fas fa-save mr-2 submit-icon"></i>
                <span class="submit-text">Konfirmasi Penerimaan</span>
            </button>
        </div>
    </form>
</div>

<!-- Info Card -->
<div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-6">
    <div class="flex items-start">
        <div class="bg-blue-100 rounded-lg p-2 mr-4">
            <i class="fas fa-info-circle text-blue-600 text-xl"></i>
        </div>
        <div class="flex-1">
            <h4 class="font-semibold text-blue-900 mb-2">Panduan Penerimaan Barang</h4>
            <ul class="text-sm text-blue-800 space-y-1">
                <li><i class="fas fa-check-circle mr-2"></i>Pastikan nomor tanda terima sesuai dengan dokumen dari supplier</li>
                <li><i class="fas fa-check-circle mr-2"></i>Cek kembali jumlah barang yang diterima untuk setiap item</li>
                <li><i class="fas fa-check-circle mr-2"></i><strong>Serial Number</strong>: Wajib diisi untuk kategori yang ditandai wajib serial number (satu per baris)</li>
                <li><i class="fas fa-check-circle mr-2"></i><strong>Serial Unit</strong>: Otomatis di-generate oleh sistem untuk semua barang</li>
                <li><i class="fas fa-check-circle mr-2"></i>Anda bisa menerima barang sebagian (partial receiving)</li>
                <li><i class="fas fa-check-circle mr-2"></i>Setelah semua barang lengkap, pengadaan siap diselesaikan</li>
            </ul>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 overflow-y-auto">
    <div class="min-h-full flex items-center justify-center p-4">
        <div class="relative w-full max-w-2xl bg-white rounded-lg shadow-xl animate-fade-in">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-invoice text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Konfirmasi Penerimaan Barang</h3>
                        <p class="text-sm text-gray-500">Pastikan data sudah benar</p>
                    </div>
                </div>
                <button onclick="closeConfirmModal()" class="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-gray-600 text-sm"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-5">
                <p class="text-gray-700 mb-4">Apakah data penerimaan barang berikut sudah benar?</p>

                <!-- Summary -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h6 class="font-semibold text-gray-800 mb-3">Ringkasan Penerimaan:</h6>

                    <div class="space-y-2 text-sm">
                        <div class="flex">
                            <span class="w-40 text-gray-600">No. Invoice:</span>
                            <span class="font-medium text-gray-800" id="summaryInvoice">-</span>
                        </div>
                        <div class="flex">
                            <span class="w-40 text-gray-600">Pengadaan #:</span>
                            <span class="font-medium text-gray-800">{{ procurement.id }}</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <span class="text-sm text-gray-600">Barang yang diterima:</span>
                        <div id="summaryItems" class="mt-2 space-y-1 text-sm">
                            <!-- Items will be listed here -->
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex">
                            <span class="w-40 text-gray-600">Total Diterima:</span>
                            <span class="font-bold text-blue-600" id="summaryTotal">0 unit</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm inline-flex items-center gap-2">
                    <i class="fas fa-times"></i>
                    <span>Batal</span>
                </button>
                <button onclick="submitForm()" id="modalSubmitBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium text-sm inline-flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-check modal-submit-icon"></i>
                    <span class="modal-submit-text">Ya, Konfirmasi</span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.animate-fade-in {
    animation: fade-in 0.2s ease-out;
}
</style>

<script>
// Store the starting number for each procurement item
const serialUnitCounters = {};

function updateSerialUnits(procurementItemId, itemCode) {
    const quantityInput = document.getElementById('quantity_' + procurementItemId);
    const quantity = parseInt(quantityInput.value) || 0;

    // Initialize counter if not exists
    if (!serialUnitCounters[procurementItemId]) {
        serialUnitCounters[procurementItemId] = 1;
    }

    if (quantity > 0) {
        // Generate serial units (will be submitted as hidden field)
        const serialUnits = [];
        for (let i = 0; i < quantity; i++) {
            const numStr = String(serialUnitCounters[procurementItemId] + i).padStart(3, '0');
            serialUnits.push(`${itemCode}-${numStr}`);
        }

        // Update the hidden field with newline-separated values
        const hiddenField = document.getElementById('serial_units_' + procurementItemId);
        if (hiddenField) {
            hiddenField.value = serialUnits.join('\n');
        }
    }
}

function updateSerialNumberCounter(procurementItemId, expectedCount) {
    const textarea = document.getElementById('serial_numbers_' + procurementItemId);
    const countSpan = document.getElementById('sn_count_' + procurementItemId);
    const warningP = document.getElementById('sn_warning_' + procurementItemId);

    if (!textarea || !countSpan) return;

    // Get all lines and trim whitespace
    const lines = textarea.value.split('\n').map(line => line.trim()).filter(line => line !== '');
    const count = lines.length;

    // Check for duplicates within the same textarea
    const uniqueLines = [...new Set(lines)];
    const hasDuplicates = uniqueLines.length < count;

    // Update counter display
    countSpan.textContent = count;

    // Update color based on count and duplicates
    countSpan.classList.remove('text-amber-600', 'text-green-600', 'text-red-600');
    if (hasDuplicates) {
        countSpan.classList.add('text-red-600');
    } else if (count === 0) {
        countSpan.classList.add('text-amber-600');
    } else if (count === expectedCount) {
        countSpan.classList.add('text-green-600');
    } else if (count < expectedCount) {
        countSpan.classList.add('text-amber-600');
    } else {
        countSpan.classList.add('text-red-600');
    }

    // Show/hide warning message
    if (warningP) {
        if (hasDuplicates) {
            warningP.classList.remove('hidden', 'text-amber-600');
            warningP.classList.add('text-red-600');
            const duplicateCount = count - uniqueLines.length;
            warningP.querySelector('span').innerHTML = `<strong>Ada ${duplicateCount} serial number duplikat!</strong> Setiap serial number harus unik.`;
        } else if (count > expectedCount) {
            warningP.classList.remove('hidden', 'text-amber-600');
            warningP.classList.add('text-red-600');
            warningP.querySelector('span').textContent = `Terlalu banyak! Harap masukkan tepat ${expectedCount} serial number.`;
        } else if (count > 0 && count < expectedCount) {
            warningP.classList.remove('hidden', 'text-red-600');
            warningP.classList.add('text-amber-600');
            warningP.querySelector('span').textContent = `Masih kurang ${expectedCount - count} serial number lagi.`;
        } else {
            warningP.classList.add('hidden');
        }
    }
}

// Call on page load to initialize serial units for ALL items
document.addEventListener('DOMContentLoaded', function() {
    {% for proc_item in procurement.items %}
    {% if proc_item.item %}
    // Initialize serial units on page load
    updateSerialUnits({{ proc_item.id }}, '{{ proc_item.item.item_code }}');

    // Initialize serial number counter for items yang require_serial_number
    {% if proc_item.item and proc_item.item.category and proc_item.item.category.require_serial_number %}
    updateSerialNumberCounter({{ proc_item.id }}, {{ proc_item.remaining_quantity }});
    {% endif %}
    {% endif %}
    {% endfor %}
});

// Modal Functions
function showConfirmModal() {
    const form = document.querySelector('form');

    // Check form validation first
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const invoiceField = document.querySelector('[name="receipt_number"]');
    const invoiceValue = invoiceField ? invoiceField.value.trim() : '{{ procurement.receipt_number or "" }}';

    if (!invoiceValue) {
        alert('Harap isi nomor invoice/tanda terima!');
        if (invoiceField) {
            invoiceField.focus();
        }
        return;
    }

    // Check for duplicate serial numbers in networking items
    const serialNumberTextareas = document.querySelectorAll('[id^="serial_numbers_"]');
    for (let textarea of serialNumberTextareas) {
        if (!textarea.disabled && textarea.value.trim()) {
            const lines = textarea.value.split('\n').map(line => line.trim()).filter(line => line !== '');
            const uniqueLines = [...new Set(lines)];

            if (uniqueLines.length < lines.length) {
                const procItemId = textarea.id.replace('serial_numbers_', '');
                const itemCard = textarea.closest('.bg-gray-50');
                const itemName = itemCard.querySelector('h5')?.textContent.trim() || 'Item';

                alert(`Serial number duplikat ditemukan untuk "${itemName}"!\n\nSetiap serial number harus unik. Mohon periksa kembali input Anda.`);
                textarea.focus();
                return;
            }

            // Also check if count matches expected quantity
            const procItemId = textarea.id.replace('serial_numbers_', '');
            const quantityInput = document.getElementById('quantity_' + procItemId);
            const expectedCount = parseInt(quantityInput?.value) || 0;

            if (lines.length !== expectedCount) {
                const itemCard = textarea.closest('.bg-gray-50');
                const itemName = itemCard.querySelector('h5')?.textContent.trim() || 'Item';

                alert(`Jumlah serial number (${lines.length}) tidak sesuai dengan jumlah barang (${expectedCount}) untuk "${itemName}"!\n\nUntuk kategori ini, jumlah serial number harus sama dengan jumlah barang yang diterima.`);
                textarea.focus();
                return;
            }
        }
    }

    // Get all procurement items
    const itemCards = document.querySelectorAll('[id^="quantity_"]');
    let totalReceived = 0;
    let hasItem = false;

    // Populate summary items
    const summaryItems = document.getElementById('summaryItems');
    summaryItems.innerHTML = '';

    itemCards.forEach(input => {
        const procItemId = input.id.replace('quantity_', '');
        const quantity = parseInt(input.value) || 0;

        if (quantity > 0) {
            hasItem = true;
            totalReceived += quantity;

            // Find item name (need to get from the DOM)
            const itemCard = input.closest('.bg-gray-50');
            const itemName = itemCard.querySelector('h5')?.textContent.trim() || 'Item Unknown';
            const requestedQty = itemCard.querySelector('.bg-blue-100')?.textContent.trim() || '';

            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-start justify-between bg-white p-2 rounded';
            itemDiv.innerHTML = `
                <div class="flex-1">
                    <span class="font-medium text-gray-800">${itemName}</span>
                    <span class="text-gray-500 text-xs ml-2">(${requestedQty})</span>
                </div>
                <span class="font-bold text-blue-600">+${quantity} unit</span>
            `;
            summaryItems.appendChild(itemDiv);
        }
    });

    if (!hasItem) {
        alert('Harap isi minimal satu barang yang diterima!');
        return;
    }

    // Update summary
    document.getElementById('summaryInvoice').textContent = invoiceValue;
    document.getElementById('summaryTotal').textContent = totalReceived + ' unit';

    // Show modal
    document.getElementById('confirmModal').classList.remove('hidden');
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

function submitForm() {
    const submitBtn = document.getElementById('submitBtn');
    const modalSubmitBtn = document.getElementById('modalSubmitBtn');
    const icon = submitBtn.querySelector('.submit-icon');
    const text = submitBtn.querySelector('.submit-text');
    const modalIcon = modalSubmitBtn.querySelector('.modal-submit-icon');
    const modalText = modalSubmitBtn.querySelector('.modal-submit-text');

    submitBtn.disabled = true;
    modalSubmitBtn.disabled = true;
    if (icon) icon.className = 'fas fa-spinner fa-spin mr-2 submit-icon';
    if (text) text.textContent = 'Memproses...';
    if (modalIcon) modalIcon.className = 'fas fa-spinner fa-spin modal-submit-icon';
    if (modalText) modalText.textContent = 'Memproses...';

    document.querySelector('form').submit();
}

// Close modal on outside click
document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeConfirmModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeConfirmModal();
    }
});
</script>
{% endblock %}
