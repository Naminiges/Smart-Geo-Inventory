{% extends "base.html" %}

{% block title %}{% if is_admin %}Buat Pengadaan Barang{% else %}Buat Permohonan Pengadaan{% endif %} - Smart Geo Inventory{% endblock %}

{% block page_title %}{% if is_admin %}Buat Pengadaan Barang{% else %}Buat Permohonan Pengadaan{% endif %}{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-4">
    <a href="{{ url_for('procurement.index') }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali ke Daftar Pengadaan
    </a>
</div>

{% if is_admin %}
<!-- Info Banner for Admin -->
<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-6">
    <div class="flex items-start">
        <div class="bg-emerald-100 rounded-lg p-2 mr-4">
            <i class="fas fa-info-circle text-emerald-600 text-xl"></i>
        </div>
        <div>
            <h4 class="font-semibold text-emerald-900 mb-1">Pengadaan Langsung (Admin)</h4>
            <p class="text-sm text-emerald-800">
                Sebagai admin, pengadaan yang Anda buat akan langsung disetujui tanpa perlu verifikasi tambahan. Supplier akan ditetapkan secara otomatis.
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Form Card -->
<div class="bg-white rounded-xl shadow-md">
    <div class="p-6 border-b border-gray-200">
        <div class="flex items-center">
            <div class="{% if is_admin %}bg-emerald-100{% else %}bg-blue-100{% endif %} rounded-lg p-3 mr-4">
                <i class="fas {% if is_admin %}fa-clipboard-check text-emerald-600{% else %}fa-clipboard-list text-blue-600{% endif %} text-2xl"></i>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-1">
                    {% if is_admin %}
                        Form Pengadaan Barang
                    {% else %}
                        Form Permohonan Pengadaan Barang
                    {% endif %}
                </h3>
                <p class="text-sm text-gray-500">
                    {% if is_admin %}
                        Isi detail barang yang akan diajukan (bisa multiple barang)
                    {% else %}
                        Step 1: Isi detail barang yang diajukan (bisa multiple barang)
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <form method="POST" id="procurementForm" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {{ form.hidden_tag() }}
        <input type="hidden" name="form_token" value="{{ form_token }}">

        {% if not is_admin %}
        <!-- Step Indicator for Warehouse Staff -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">1</div>
                    <span class="ml-2 text-sm font-medium text-gray-800">Permohonan</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
                <div class="flex items-center">
                    <div class="bg-gray-300 text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">2</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Persetujuan Admin</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
                <div class="flex items-center">
                    <div class="bg-gray-300 text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">3</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Penerimaan Barang</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
                <div class="flex items-center">
                    <div class="bg-gray-300 text-gray-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">4</div>
                    <span class="ml-2 text-sm font-medium text-gray-500">Selesai</span>
                </div>
            </div>
        </div>
        {% endif %}

        {% if is_admin %}
        <!-- Warehouse Selection (Admin Only) -->
        <div class="mb-6" style="position: relative; z-index: 10;">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-warehouse mr-1 text-emerald-600"></i>
                Pilih Warehouse Tujuan
            </label>
            <select name="warehouse_id" id="warehouseSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all" required style="min-height: 48px;">
                <option value="">-- Pilih Warehouse --</option>
                {% for warehouse in warehouses %}
                <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                {% endfor %}
            </select>
            <p class="mt-1 text-xs text-gray-500">Pilih warehouse tempat barang akan diterima</p>
        </div>

        <!-- Divider -->
        <div class="border-t border-gray-200 my-6"></div>

        <!-- Section Header for Items -->
        <div class="mb-4">
            <h4 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-boxes mr-2 text-emerald-600"></i>
                Detail Barang
            </h4>
            <p class="text-sm text-gray-600">Pilih barang yang akan diadakan</p>
        </div>
        {% endif %}

        <!-- Items List -->
        <div class="mb-6">
            <div class="mb-3">
                <label class="block text-sm font-semibold text-gray-700">
                    <i class="fas fa-boxes mr-1 {% if is_admin %}text-emerald-600{% else %}text-blue-600{% endif %}"></i>
                    Daftar Barang
                </label>
            </div>

            <div id="itemsContainer">
                <!-- Items will be added dynamically here -->
            </div>

            <!-- Add Item Button - Placed at the bottom for easy access -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button type="button" id="addItemBtn" class="w-full px-4 py-3 {% if is_admin %}bg-emerald-600 hover:bg-emerald-700{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white rounded-lg transition-colors font-semibold flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    Tambah Barang Lagi
                </button>
            </div>

            <p class="mt-2 text-xs text-gray-500 text-center">
                <i class="fas fa-info-circle mr-1"></i>
                Klik tombol di atas untuk menambahkan barang. Minimal 1 barang.
            </p>
        </div>

        <!-- Request Notes (Reason) -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-comment-alt mr-1 text-amber-600"></i>
                {% if is_admin %}Catatan Pengadaan{% else %}Alasan Permohonan{% endif %}
            </label>
            {{ form.request_notes(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all", rows="4", placeholder="Jelaskan alasan pengadaan barang ini (min. 10 karakter)") }}
            {% if form.request_notes.errors %}
                {% for error in form.request_notes.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                {% endfor %}
            {% endif %}
            <p class="mt-1 text-xs text-gray-500">Contoh: Penggantian unit yang rusak, Tambahan untuk kebutuhan baru, dll</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200">
            <a href="{{ url_for('procurement.index') }}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                <i class="fas fa-times mr-2"></i>
                Batal
            </a>
            <button type="button" onclick="showConfirmModal()" class="px-6 py-3 {% if is_admin %}bg-emerald-600 hover:bg-emerald-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white rounded-lg transition-colors font-semibold">
                <i class="fas fa-paper-plane mr-2"></i>
                {% if is_admin %}Buat Pengadaan{% else %}Ajukan Permohonan{% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Info Card -->
<div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-6">
    <div class="flex items-start">
        <div class="bg-blue-100 rounded-lg p-2 mr-4">
            <i class="fas fa-info-circle text-blue-600 text-xl"></i>
        </div>
        <div>
            <h4 class="font-semibold text-blue-900 mb-2">Informasi Penting</h4>
            <ul class="text-sm text-blue-800 space-y-1">
                <li><i class="fas fa-check-circle mr-2"></i>Anda dapat menambahkan multiple barang dalam satu permohonan</li>
                <li><i class="fas fa-check-circle mr-2"></i>Pilih barang dari daftar jika barang sudah terdaftar di sistem</li>
                <li><i class="fas fa-check-circle mr-2"></i>Jika barang baru, sistem akan otomatis membuat item baru</li>
                <li><i class="fas fa-check-circle mr-2"></i>Permohonan akan melalui proses persetujuan admin</li>
                <li><i class="fas fa-check-circle mr-2"></i>Admin akan menetapkan warehouse tujuan dan menyetujui permohonan</li>
            </ul>
        </div>
    </div>
</div>

<!-- Item Template (Hidden) -->
<template id="itemTemplate">
    <div class="item-card bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4" data-item-index="">
        <div class="flex items-center justify-between mb-3">
            <h5 class="text-sm font-semibold text-gray-800">
                <span class="item-number">1</span>. Barang
            </h5>
            <button type="button" class="remove-item-btn text-red-600 hover:text-red-800 transition-colors">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <!-- Item Selection -->
        <div class="mb-3" style="position: relative; z-index: 10;">
            <label class="block text-xs font-semibold text-gray-700 mb-1">Pilih Barang (Pilih "Barang Baru" jika tidak menemukan)</label>
            <input type="text" class="item-search w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm" placeholder="Cari barang..." autocomplete="off">
            <select class="item-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm hidden" style="min-height: 42px;" tabindex="-1">
                <option value="0">-- Pilih dari daftar barang --</option>
                {% for item in items %}
                <option value="{{ item.id }}" data-search-text="{{ item.item_code }} {{ item.name }}">{{ item.item_code }} - {{ item.name }}</option>
                {% endfor %}
                <option value="-1" data-search-text="lainnya barang baru">Lainnya (Barang Baru)</option>
            </select>

            <!-- Scrollable Item List Card -->
            <div class="item-search-results bg-white border border-gray-300 rounded-lg mt-1 shadow-lg hidden">
                <div class="item-list-container p-1">
                    <!-- Items will be populated here -->
                </div>
            </div>
        </div>

        <!-- New Item Fields (Hidden by default) -->
        <div class="new-item-fields hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                <h6 class="text-xs font-semibold text-green-900 mb-2">Detail Barang Baru</h6>

                <!-- New Item Name -->
                <div class="mb-2">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Nama Barang</label>
                    <input type="text" class="new-item-name w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all text-sm" placeholder="Contoh: Laptop Dell Latitude 5420" data-auto-save="true">
                    <div class="item-name-warning mt-1 text-xs text-amber-600 hidden"></div>
                </div>

                <!-- New Item Category -->
                <div class="mb-2" style="position: relative; z-index: 10;">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Kategori Barang (Tambah baru di "Kategori Barang" jika tidak menemukan)</label>
                    <input type="text" class="category-search w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all text-sm" placeholder="Cari kategori..." autocomplete="off">
                    <select class="new-item-category w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all text-sm hidden" style="min-height: 42px;" tabindex="-1">
                        <option value="0">-- Pilih Kategori --</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" data-search-text="{{ category.name }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>

                    <!-- Scrollable Category List Card -->
                    <div class="category-search-results bg-white border border-gray-300 rounded-lg mt-1 shadow-lg hidden">
                        <div class="category-list-container p-1">
                            <!-- Categories will be populated here -->
                        </div>
                    </div>
                    <div class="category-warning mt-1 text-xs text-amber-600 hidden"></div>
                </div>

                <!-- New Item Unit -->
                <div class="mb-0">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Satuan Barang</label>
                    <input type="text" class="new-item-unit w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all text-sm" placeholder="Contoh: pcs, unit, buah" data-auto-save="true">
                </div>
            </div>
        </div>

        <!-- Quantity -->
        <div class="mb-0">
            <label class="block text-xs font-semibold text-gray-700 mb-1">Kuantitas</label>
            <input type="number" class="item-quantity w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-sm" placeholder="Masukkan jumlah barang" min="1" required>
        </div>
    </div>
</template>

<!-- Restore Draft Modal -->
<div id="restoreDraftModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 overflow-y-auto">
    <div class="min-h-full flex items-center justify-center p-4">
        <div class="relative w-full max-w-md bg-white rounded-lg shadow-xl animate-fade-in">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clock text-amber-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Draft Ditemukan!</h3>
                        <p class="text-sm text-gray-500">Data form tersimpan sebelumnya</p>
                    </div>
                </div>
                <p class="text-gray-700 mb-4">Kami menemukan data form yang belum selesai. Apakah Anda ingin melanjutkan?</p>
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div id="draftSummary" class="text-sm text-gray-600">
                        <!-- Draft summary will be shown here -->
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="discardDraft()" class="flex-1 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors font-medium text-sm">
                        <i class="fas fa-trash mr-2"></i>Buang Draft
                    </button>
                    <button onclick="restoreDraft()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm">
                        <i class="fas fa-check mr-2"></i>Lanjutkan
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 overflow-y-auto">
    <div class="min-h-full flex items-center justify-center p-4">
        <div class="relative w-full max-w-2xl bg-white rounded-lg shadow-xl animate-fade-in">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="{% if is_admin %}w-10 h-10 bg-emerald-500{% else %}w-10 h-10 bg-blue-500{% endif %} rounded-lg flex items-center justify-center">
                        <i class="fas {% if is_admin %}fa-clipboard-check{% else %}fa-clipboard-list{% endif %} text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Konfirmasi {% if is_admin %}Pengadaan{% else %}Permohonan{% endif %}</h3>
                        <p class="text-sm text-gray-500">Pastikan data sudah benar</p>
                    </div>
                </div>
                <button onclick="closeConfirmModal()" class="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-gray-600 text-sm"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-5">
                <p class="text-gray-700 mb-4">Apakah data {% if is_admin %}pengadaan{% else %}permohonan{% endif %} berikut sudah benar?</p>

                <!-- Summary -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h6 class="font-semibold text-gray-800 mb-3">Ringkasan Data:</h6>

                    {% if is_admin %}
                    <div class="space-y-2 text-sm">
                        <div class="flex">
                            <span class="w-32 text-gray-600">Warehouse:</span>
                            <span class="font-medium text-gray-800" id="summaryWarehouse">-</span>
                        </div>
                    </div>
                    {% endif %}

                    <div class="mt-3">
                        <span class="text-sm text-gray-600">Barang yang diajukan:</span>
                        <div id="summaryItems" class="mt-2 space-y-1 text-sm">
                            <!-- Items will be listed here -->
                        </div>
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <div class="flex">
                            <span class="w-32 text-gray-600">Catatan:</span>
                            <span class="font-medium text-gray-800" id="summaryNotes">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm inline-flex items-center gap-2">
                    <i class="fas fa-times"></i>
                    <span>Batal</span>
                </button>
                <button onclick="submitForm()" class="px-4 py-2 {% if is_admin %}bg-emerald-600 hover:bg-emerald-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white rounded-lg transition-colors font-medium text-sm inline-flex items-center gap-2">
                    <i class="fas fa-check"></i>
                    <span>Ya, Ajukan</span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.animate-fade-in {
    animation: fade-in 0.2s ease-out;
}
</style>

<script>
// Auto-save and Restore functionality
const DRAFT_KEY = 'procurement_draft';
const DRAFT_TIMEOUT_KEY = 'procurement_draft_time';
let hasChanges = false;
let autoSaveTimer = null;

// Save draft to localStorage
function saveDraft() {
    const form = document.getElementById('procurementForm');
    const itemsContainer = document.getElementById('itemsContainer');
    const itemCards = itemsContainer.querySelectorAll('.item-card');

    const itemsData = [];

    itemCards.forEach(card => {
        const itemSelect = card.querySelector('.item-select');
        const itemSearch = card.querySelector('.item-search');
        const itemQuantity = card.querySelector('.item-quantity');
        const newItemName = card.querySelector('.new-item-name');
        const newItemCategory = card.querySelector('.new-item-category');
        const categorySearch = card.querySelector('.category-search');
        const newItemUnit = card.querySelector('.new-item-unit');

        const itemData = {
            item_id: itemSelect.value,
            item_search: itemSearch?.value || '',
            quantity: itemQuantity?.value || '1'
        };

        if (itemSelect.value === '-1') {
            itemData.new_item_name = newItemName?.value || '';
            itemData.new_item_category_id = newItemCategory?.value || '';
            itemData.category_search = categorySearch?.value || '';
            itemData.new_item_unit = newItemUnit?.value || '';
        }

        itemsData.push(itemData);
    });

    const draftData = {
        request_notes: form.querySelector('[name="request_notes"]')?.value || '',
        warehouse_id: document.getElementById('warehouseSelect')?.value || '',
        items: itemsData,
        timestamp: Date.now()
    };

    localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
    localStorage.setItem(DRAFT_TIMEOUT_KEY, Date.now().toString());
    hasChanges = true;
}

// Restore draft from localStorage
function restoreDraftFromStorage() {
    const draftData = localStorage.getItem(DRAFT_KEY);
    if (!draftData) return false;

    const draft = JSON.parse(draftData);

    // Check if draft is too old (24 hours)
    const draftAge = Date.now() - draft.timestamp;
    if (draftAge > 24 * 60 * 60 * 1000) {
        localStorage.removeItem(DRAFT_KEY);
        localStorage.removeItem(DRAFT_TIMEOUT_KEY);
        return false;
    }

    return draft;
}

// Load draft data into form
function loadDraftData(draft, setupItemSearchFn, setupCategorySearchFn, setupItemNameCheckFn, checkDuplicateItemsFn, updateItemNumbersFn, scheduleAutoSaveFn) {
    const form = document.getElementById('procurementForm');
    const itemTemplate = document.getElementById('itemTemplate');
    const itemsContainer = document.getElementById('itemsContainer');
    let itemCount = 0;

    // Restore notes
    if (draft.request_notes) {
        form.querySelector('[name="request_notes"]').value = draft.request_notes;
    }

    // Restore warehouse selection (for admin)
    if (draft.warehouse_id && document.getElementById('warehouseSelect')) {
        document.getElementById('warehouseSelect').value = draft.warehouse_id;
    }

    // Clear existing items
    itemsContainer.innerHTML = '';

    // Add saved items
    draft.items.forEach(itemData => {
        const template = itemTemplate.content.cloneNode(true);
        const itemCard = template.querySelector('.item-card');

        // Set unique index
        itemCard.dataset.itemIndex = itemCount;
        itemCard.querySelector('.item-number').textContent = itemCount + 1;

        const itemSelect = itemCard.querySelector('.item-select');
        const itemSearch = itemCard.querySelector('.item-search');
        const itemQuantity = itemCard.querySelector('.item-quantity');
        const newItemFields = itemCard.querySelector('.new-item-fields');
        const removeBtn = itemCard.querySelector('.remove-item-btn');

        // Set item values
        itemSelect.value = itemData.item_id;
        itemSearch.value = itemData.item_search || itemSelect.options[itemSelect.selectedIndex]?.text || '';
        itemQuantity.value = itemData.quantity || '1';

        // Show new item fields if needed
        if (itemData.item_id === '-1') {
            newItemFields.classList.remove('hidden');

            const newItemName = itemCard.querySelector('.new-item-name');
            const newItemCategory = itemCard.querySelector('.new-item-category');
            const categorySearch = itemCard.querySelector('.category-search');
            const newItemUnit = itemCard.querySelector('.new-item-unit');

            newItemName.value = itemData.new_item_name || '';
            newItemCategory.value = itemData.new_item_category_id || '';
            categorySearch.value = itemData.category_search || '';
            newItemUnit.value = itemData.new_item_unit || '';
        }

        // Setup event listeners
        setupItemSearchFn(itemSearch, itemSelect, itemSearch.parentElement.querySelector('.item-search-results'), newItemFields);

        // Add auto-save listeners
        itemSearch.addEventListener('input', scheduleAutoSaveFn);

        itemSelect.addEventListener('change', function() {
            if (this.value === '-1') {
                newItemFields.classList.remove('hidden');
            } else {
                newItemFields.classList.add('hidden');
            }
            checkDuplicateItemsFn();
            scheduleAutoSaveFn();
        });

        const categorySearchEl = itemCard.querySelector('.category-search');
        const categorySelect = itemCard.querySelector('.new-item-category');
        const categorySearchResults = itemCard.querySelector('.category-search-results');
        const categoryWarning = itemCard.querySelector('.category-warning');

        if (categorySearchEl && categorySelect && categorySearchResults) {
            setupCategorySearchFn(categorySearchEl, categorySelect, categorySearchResults, categoryWarning);
        }

        const newItemName = itemCard.querySelector('.new-item-name');
        const itemNameWarning = itemCard.querySelector('.item-name-warning');

        if (newItemName && itemNameWarning) {
            setupItemNameCheckFn(newItemName, itemNameWarning, itemSelect);
            // Add auto-save listener
            newItemName.addEventListener('input', scheduleAutoSaveFn);
        }

        // Add auto-save to quantity field
        if (itemQuantity) {
            itemQuantity.addEventListener('input', scheduleAutoSaveFn);
        }

        // Add auto-save to new item unit field
        const newItemUnit = itemCard.querySelector('.new-item-unit');
        if (newItemUnit) {
            newItemUnit.addEventListener('input', scheduleAutoSaveFn);
        }

        removeBtn.addEventListener('click', function() {
            if (itemsContainer.children.length > 1) {
                itemCard.remove();
                updateItemNumbersFn();
                scheduleAutoSaveFn();
            } else {
                alert('Minimal harus ada satu barang!');
            }
        });

        itemsContainer.appendChild(itemCard);
        itemCount++;
    });

    hasChanges = true;
}

// Schedule auto-save (debounced)
function scheduleAutoSave() {
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    autoSaveTimer = setTimeout(saveDraft, 1000);
}

// Discard draft
function discardDraft() {
    localStorage.removeItem(DRAFT_KEY);
    localStorage.removeItem(DRAFT_TIMEOUT_KEY);
    document.getElementById('restoreDraftModal').classList.add('hidden');
    hasChanges = false;
}

// Restore draft from modal (global, will be overridden inside DOMContentLoaded)
window.restoreDraft = function() {
    const draft = restoreDraftFromStorage();
    if (draft && window._restoreDraftCallback) {
        window._restoreDraftCallback(draft);
    }
    document.getElementById('restoreDraftModal').classList.add('hidden');
}

// Check for draft on page load and show modal
function checkForDraft() {
    const draftData = localStorage.getItem(DRAFT_KEY);
    if (!draftData) return false;

    const draft = JSON.parse(draftData);

    // Check if draft is too old (24 hours)
    const draftAge = Date.now() - draft.timestamp;
    if (draftAge > 24 * 60 * 60 * 1000) {
        localStorage.removeItem(DRAFT_KEY);
        localStorage.removeItem(DRAFT_TIMEOUT_KEY);
        return false;
    }

    // Show draft summary in modal
    const summaryDiv = document.getElementById('draftSummary');
    const date = new Date(draft.timestamp);
    summaryDiv.innerHTML = `
        <div class="flex items-center justify-between">
            <span><i class="fas fa-clock mr-2"></i>Disimpan: ${date.toLocaleString('id-ID')}</span>
            <span class="font-semibold">${draft.items.length} barang</span>
        </div>
    `;

    document.getElementById('restoreDraftModal').classList.remove('hidden');
    return true;
}

// Clear draft after successful submission
function clearDraft() {
    localStorage.removeItem(DRAFT_KEY);
    localStorage.removeItem(DRAFT_TIMEOUT_KEY);
    hasChanges = false;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('procurementForm');
    const itemsContainer = document.getElementById('itemsContainer');
    const addItemBtn = document.getElementById('addItemBtn');
    const itemTemplate = document.getElementById('itemTemplate');
    let itemCount = 0;

    // Set up callback for restoring draft
    window._restoreDraftCallback = function(draft) {
        loadDraftData(draft, setupItemSearch, setupCategorySearch, setupItemNameCheck, checkDuplicateItems, updateItemNumbers, scheduleAutoSave);
    };

    // Check for existing draft first
    const hasDraft = checkForDraft();

    // Only add first item if no draft is being restored
    if (!hasDraft) {
        addItem();
    }

    // Add item button click handler
    addItemBtn.addEventListener('click', addItem);

    // Add auto-save listeners to form fields
    const notesField = form.querySelector('[name="request_notes"]');
    if (notesField) {
        notesField.addEventListener('input', scheduleAutoSave);
    }

    const warehouseSelect = document.getElementById('warehouseSelect');
    if (warehouseSelect) {
        warehouseSelect.addEventListener('change', scheduleAutoSave);
    }

    // Warn before leaving page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasChanges) {
            e.preventDefault();
            e.returnValue = 'Anda memiliki perubahan yang belum disimpan. Data tersimpan sebagai draft dan bisa dilanjutkan nanti.';
            return e.returnValue;
        }
    });

    function addItem() {
        const template = itemTemplate.content.cloneNode(true);
        const itemCard = template.querySelector('.item-card');

        // Set unique index
        itemCard.dataset.itemIndex = itemCount;
        itemCard.querySelector('.item-number').textContent = itemCount + 1;

        // Add event listeners for this item
        const itemSelect = itemCard.querySelector('.item-select');
        const itemSearch = itemCard.querySelector('.item-search');
        const itemSearchResults = itemCard.querySelector('.item-search-results');
        const newItemFields = itemCard.querySelector('.new-item-fields');
        const removeBtn = itemCard.querySelector('.remove-item-btn');

        // Setup search functionality for item selection
        setupItemSearch(itemSearch, itemSelect, itemSearchResults, newItemFields);

        // Add auto-save listeners
        itemSearch.addEventListener('input', scheduleAutoSave);

        // Show/hide new item fields
        itemSelect.addEventListener('change', function() {
            if (this.value === '-1') {
                newItemFields.classList.remove('hidden');
            } else {
                newItemFields.classList.add('hidden');
            }

            // Check for duplicate items
            checkDuplicateItems();
            scheduleAutoSave();
        });

        // Setup category search
        const categorySearch = itemCard.querySelector('.category-search');
        const categorySelect = itemCard.querySelector('.new-item-category');
        const categorySearchResults = itemCard.querySelector('.category-search-results');
        const categoryWarning = itemCard.querySelector('.category-warning');

        if (categorySearch && categorySelect && categorySearchResults) {
            setupCategorySearch(categorySearch, categorySelect, categorySearchResults, categoryWarning);
        }

        // Setup item name validation (check for existing items)
        const newItemName = itemCard.querySelector('.new-item-name');
        const itemNameWarning = itemCard.querySelector('.item-name-warning');

        if (newItemName && itemNameWarning) {
            setupItemNameCheck(newItemName, itemNameWarning, itemSelect);
            // Add auto-save listener
            newItemName.addEventListener('input', scheduleAutoSave);
        }

        // Add auto-save to quantity field
        const itemQuantity = itemCard.querySelector('.item-quantity');
        if (itemQuantity) {
            itemQuantity.addEventListener('input', scheduleAutoSave);
        }

        // Add auto-save to new item unit field
        const newItemUnit = itemCard.querySelector('.new-item-unit');
        if (newItemUnit) {
            newItemUnit.addEventListener('input', scheduleAutoSave);
        }

        // Remove item button
        removeBtn.addEventListener('click', function() {
            if (itemsContainer.children.length > 1) {
                itemCard.remove();
                updateItemNumbers();
                scheduleAutoSave();
            } else {
                alert('Minimal harus ada satu barang!');
            }
        });

        itemsContainer.appendChild(itemCard);
        itemCount++;
    }

    function setupItemSearch(searchInput, selectElement, resultsDiv, newItemFields) {
        let selectedIndex = -1;
        const listContainer = resultsDiv.querySelector('.item-list-container');

        searchInput.addEventListener('focus', function() {
            // Show all items when focused
            showAllOptions();
            resultsDiv.classList.remove('hidden');
        });

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            filterOptions(searchTerm);
            selectedIndex = -1;
            resultsDiv.classList.remove('hidden');
        });

        searchInput.addEventListener('keydown', function(e) {
            const options = resultsDiv.querySelectorAll('.search-option');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
                updateSelectedOption(options);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelectedOption(options);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < options.length) {
                    options[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                this.value = '';
                resultsDiv.classList.add('hidden');
            }
        });

        searchInput.addEventListener('blur', function() {
            // Hide the list after delay to allow click events
            setTimeout(() => {
                resultsDiv.classList.add('hidden');
            }, 200);
        });

        function filterOptions(searchTerm) {
            const options = selectElement.querySelectorAll('option');
            listContainer.innerHTML = '';

            let hasResults = false;
            let hasNewItemOption = false;

            options.forEach(option => {
                const searchText = option.getAttribute('data-search-text')?.toLowerCase() || option.textContent.toLowerCase();

                // Always show "Lainnya (Barang Baru)" option at the top
                if (option.value === '-1') {
                    hasNewItemOption = true;
                    const div = document.createElement('div');
                    div.className = 'search-option px-3 py-1.5 cursor-pointer hover:bg-green-50 transition-colors bg-green-50 font-semibold text-green-800 text-sm';
                    div.textContent = option.textContent;
                    div.dataset.value = option.value;
                    div.addEventListener('click', function() {
                        selectElement.value = this.dataset.value;
                        searchInput.value = option.textContent;

                        // Trigger change event
                        selectElement.dispatchEvent(new Event('change'));

                        if (selectElement.value === '-1') {
                            newItemFields.classList.remove('hidden');
                        } else {
                            newItemFields.classList.add('hidden');
                        }
                    });
                    listContainer.appendChild(div);
                } else if (searchText.includes(searchTerm)) {
                    hasResults = true;
                    const div = document.createElement('div');
                    div.className = 'search-option px-3 py-1.5 cursor-pointer hover:bg-blue-50 transition-colors text-sm';
                    div.textContent = option.textContent;
                    div.dataset.value = option.value;
                    div.addEventListener('click', function() {
                        selectElement.value = this.dataset.value;
                        searchInput.value = option.textContent;

                        // Trigger change event
                        selectElement.dispatchEvent(new Event('change'));

                        if (selectElement.value === '-1') {
                            newItemFields.classList.remove('hidden');
                        } else {
                            newItemFields.classList.add('hidden');
                        }
                    });
                    listContainer.appendChild(div);
                }
            });

            // Show no results message if no matches found (but still show "Barang Baru" option)
            if (!hasResults && searchTerm !== '') {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'search-option px-3 py-1.5 text-gray-500 text-sm italic cursor-default';
                noResultsDiv.textContent = `Tidak ditemukan: "${searchInput.value}"`;
                listContainer.insertBefore(noResultsDiv, listContainer.firstChild);
            }

            // Dynamic height: if items > 6, set max height with scroll, otherwise fit content
            const itemCount = listContainer.children.length;
            if (itemCount > 6) {
                resultsDiv.style.height = '160px';
                resultsDiv.style.overflowY = 'auto';
            } else {
                resultsDiv.style.height = 'auto';
                resultsDiv.style.overflowY = 'visible';
            }
        }

        function showAllOptions() {
            filterOptions('');
        }

        function updateSelectedOption(options) {
            options.forEach((opt, index) => {
                if (index === selectedIndex) {
                    opt.classList.add('bg-blue-100');
                    opt.scrollIntoView({ block: 'nearest' });
                } else {
                    opt.classList.remove('bg-blue-100');
                }
            });
        }
    }

    function setupCategorySearch(searchInput, selectElement, resultsDiv, warningDiv) {
        let selectedIndex = -1;
        let isClickingOption = false;
        const listContainer = resultsDiv.querySelector('.category-list-container');

        searchInput.addEventListener('focus', function() {
            // Show all categories when focused
            showAllOptions();
            resultsDiv.classList.remove('hidden');
        });

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            filterOptions(searchTerm);
            selectedIndex = -1;
            resultsDiv.classList.remove('hidden');

            // Clear warning while typing
            if (warningDiv && !warningDiv.classList.contains('hidden')) {
                warningDiv.classList.add('hidden');
                warningDiv.innerHTML = '';
                searchInput.classList.remove('border-amber-400', 'bg-amber-50');
            }

            // Trigger auto-save
            scheduleAutoSave();
        });

        searchInput.addEventListener('keydown', function(e) {
            const options = resultsDiv.querySelectorAll('.search-option');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
                updateSelectedOption(options);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelectedOption(options);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < options.length) {
                    options[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                this.value = '';
                resultsDiv.classList.add('hidden');
            }
        });

        searchInput.addEventListener('blur', function() {
            // Delay to allow click event on options to fire first
            setTimeout(() => {
                // Check if user has clicked on an option
                if (isClickingOption) {
                    isClickingOption = false;
                    resultsDiv.classList.add('hidden');
                    return;
                }

                // Hide the list
                resultsDiv.classList.add('hidden');

                // Check if user has typed something but not selected an option
                const inputValue = this.value.trim();
                const selectedValue = selectElement.value;

                // If user typed something but no valid selection was made
                if (inputValue !== '' && (selectedValue === '0' || selectedValue === '')) {
                    // Show warning instead of alert
                    if (warningDiv) {
                        warningDiv.classList.remove('hidden');
                        warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>Kategori "${inputValue}" tidak ditemukan di daftar. Silakan pilih dari daftar atau tambah kategori baru di menu "Kategori Barang".`;
                        searchInput.classList.add('border-amber-400', 'bg-amber-50');
                    }
                }
            }, 200);
        });

        function filterOptions(searchTerm) {
            const options = selectElement.querySelectorAll('option');
            listContainer.innerHTML = '';

            let hasResults = false;

            options.forEach(option => {
                const searchText = option.getAttribute('data-search-text')?.toLowerCase() || option.textContent.toLowerCase();
                if (searchText.includes(searchTerm)) {
                    hasResults = true;
                    const div = document.createElement('div');
                    div.className = 'search-option px-3 py-1.5 cursor-pointer hover:bg-green-50 transition-colors text-sm';
                    div.textContent = option.textContent;
                    div.dataset.value = option.value;
                    div.addEventListener('mousedown', function() {
                        // Set flag to prevent blur warning
                        isClickingOption = true;
                    });
                    div.addEventListener('click', function() {
                        selectElement.value = this.dataset.value;
                        searchInput.value = option.textContent;

                        // Clear warning when valid category is selected
                        if (warningDiv) {
                            warningDiv.classList.add('hidden');
                            warningDiv.innerHTML = '';
                            searchInput.classList.remove('border-amber-400', 'bg-amber-50');
                        }

                        // Trigger change event
                        selectElement.dispatchEvent(new Event('change'));

                        // Trigger auto-save
                        scheduleAutoSave();
                    });
                    listContainer.appendChild(div);
                }
            });

            // Show no results message with "Add Category" link if no matches found
            if (!hasResults && searchTerm !== '') {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'search-option px-3 py-2 text-gray-600 text-sm cursor-default';
                noResultsDiv.innerHTML = `
                    <div class="text-amber-600 mb-2"><i class="fas fa-exclamation-triangle mr-1"></i>Tidak ditemukan: "${searchInput.value}"</div>
                    <a href="{{ url_for('categories.create') }}" class="inline-flex items-center bg-green-50 text-green-700 hover:bg-green-100 hover:shadow-md hover:-translate-y-0.5 font-semibold text-xs px-3 py-2 rounded-lg transition-all cursor-pointer">
                        <i class="fas fa-plus mr-1"></i>
                        Tambah Kategori "${searchInput.value}"
                    </a>
                `;
                listContainer.appendChild(noResultsDiv);
            }

            // Dynamic height: if items > 6, set max height with scroll, otherwise fit content
            const itemCount = listContainer.children.length;
            if (itemCount > 6) {
                resultsDiv.style.height = '160px';
                resultsDiv.style.overflowY = 'auto';
            } else {
                resultsDiv.style.height = 'auto';
                resultsDiv.style.overflowY = 'visible';
            }
        }

        function showAllOptions() {
            filterOptions('');
        }

        function updateSelectedOption(options) {
            options.forEach((opt, index) => {
                if (index === selectedIndex) {
                    opt.classList.add('bg-green-100');
                    opt.scrollIntoView({ block: 'nearest' });
                } else {
                    opt.classList.remove('bg-green-100');
                }
            });
        }
    }

    function setupItemNameCheck(nameInput, warningDiv, itemSelect) {
        nameInput.addEventListener('blur', function() {
            const inputName = this.value.trim().toLowerCase();

            if (inputName === '') {
                warningDiv.classList.add('hidden');
                warningDiv.innerHTML = '';
                return;
            }

            // Check against all existing items in the dropdown
            const options = itemSelect.querySelectorAll('option');
            let foundMatch = null;

            options.forEach(option => {
                if (option.value && option.value !== '0' && option.value !== '-1') {
                    const optionText = option.textContent.toLowerCase();
                    const searchText = option.getAttribute('data-search-text')?.toLowerCase() || optionText;

                    // Check if input name matches existing item name (case-insensitive)
                    if (searchText.includes(inputName) || inputName.includes(searchText.split(' - ')[1] || searchText)) {
                        foundMatch = option.textContent;
                    }
                }
            });

            if (foundMatch) {
                warningDiv.classList.remove('hidden');
                warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>Barang dengan nama mirip sudah terdaftar: "${foundMatch}". Pastikan Anda tidak membuat duplikat.`;
                nameInput.classList.add('border-amber-400', 'bg-amber-50');
            } else {
                warningDiv.classList.add('hidden');
                warningDiv.innerHTML = '';
                nameInput.classList.remove('border-amber-400', 'bg-amber-50');
            }
        });

        nameInput.addEventListener('input', function() {
            // Clear warning while typing
            if (warningDiv.classList.contains('hidden') === false) {
                warningDiv.classList.add('hidden');
                nameInput.classList.remove('border-amber-400', 'bg-amber-50');
            }
        });
    }

    function updateItemNumbers() {
        const itemCards = itemsContainer.querySelectorAll('.item-card');
        itemCards.forEach((card, index) => {
            card.querySelector('.item-number').textContent = index + 1;
        });
    }

    // Check for duplicate items
    function checkDuplicateItems() {
        const itemCards = itemsContainer.querySelectorAll('.item-card');
        const selectedItems = [];

        itemCards.forEach(card => {
            const itemSelect = card.querySelector('.item-select');
            const itemId = itemSelect.value;

            if (itemId && itemId !== '0' && itemId !== '-1') {
                const itemSearch = card.querySelector('.item-search');
                const itemName = itemSearch ? itemSearch.value : itemSelect.options[itemSelect.selectedIndex].text;

                if (selectedItems.includes(itemId)) {
                    // Duplicate found!
                    alert(`Barang "${itemName}" sudah dipilih!\n\nSilakan pilih barang yang lain atau hapus salah satu dari daftar.`);
                    itemSelect.value = '0';
                    if (itemSearch) itemSearch.value = '';
                    return;
                }

                selectedItems.push(itemId);
            }
        });
    }
});

// Modal Functions
function showConfirmModal() {
    const form = document.getElementById('procurementForm');

    // Check form validation first
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const itemCards = document.querySelectorAll('#itemsContainer .item-card');
    let hasError = false;

    // Validate items
    for (let card of itemCards) {
        const itemSelect = card.querySelector('.item-select');
        const itemQuantity = card.querySelector('.item-quantity');
        const newItemName = card.querySelector('.new-item-name');
        const newItemCategory = card.querySelector('.new-item-category');

        const itemId = parseInt(itemSelect.value);
        const quantity = parseInt(itemQuantity.value);

        if (!itemId || itemId === 0) {
            alert('Harap pilih barang dari daftar atau pilih "Lainnya"!');
            itemSelect.focus();
            return;
        }

        if (!quantity || quantity <= 0) {
            alert('Harap isi jumlah barang dengan benar!');
            itemQuantity.focus();
            return;
        }

        if (itemId === -1) {
            if (!newItemName.value.trim()) {
                alert('Harap isi nama barang baru!');
                newItemName.focus();
                return;
            }
            if (!newItemCategory.value || newItemCategory.value === '0') {
                alert('Harap pilih kategori barang baru!');
                newItemCategory.focus();
                return;
            }
        }
    }

    // Populate summary
    {% if is_admin %}
    const warehouseSelect = document.getElementById('warehouseSelect');
    document.getElementById('summaryWarehouse').textContent = warehouseSelect.options[warehouseSelect.selectedIndex]?.text || '-';
    {% endif %}

    // Summary items
    const summaryItems = document.getElementById('summaryItems');
    summaryItems.innerHTML = '';

    itemCards.forEach((card, index) => {
        const itemSelect = card.querySelector('.item-select');
        const itemQuantity = card.querySelector('.item-quantity');
        const newItemName = card.querySelector('.new-item-name');

        const itemId = parseInt(itemSelect.value);
        const quantity = itemQuantity.value;
        let itemName = '';

        if (itemId === -1) {
            itemName = newItemName.value + ' (Baru)';
        } else {
            itemName = itemSelect.options[itemSelect.selectedIndex]?.text || '-';
        }

        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex items-start';
        itemDiv.innerHTML = `
            <span class="text-gray-500 mr-2">${index + 1}.</span>
            <div>
                <span class="font-medium">${itemName}</span>
                <span class="text-gray-600 ml-2">x${quantity}</span>
            </div>
        `;
        summaryItems.appendChild(itemDiv);
    });

    // Summary notes
    const notesField = document.querySelector('[name="request_notes"]');
    document.getElementById('summaryNotes').textContent = notesField?.value || '-';

    // Show modal
    document.getElementById('confirmModal').classList.remove('hidden');
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

function submitForm() {
    const form = document.getElementById('procurementForm');
    const itemsContainer = document.getElementById('itemsContainer');
    const itemCards = itemsContainer.querySelectorAll('.item-card');
    const itemsData = [];

    // Remove any existing hidden 'items' fields from previous submissions
    const existingHiddenFields = form.querySelectorAll('input[type="hidden"][name="items"]');
    existingHiddenFields.forEach(field => field.remove());

    // Collect items data before submission
    for (let card of itemCards) {
        const itemSelect = card.querySelector('.item-select');
        const itemQuantity = card.querySelector('.item-quantity');
        const newItemName = card.querySelector('.new-item-name');
        const newItemCategory = card.querySelector('.new-item-category');
        const newItemUnit = card.querySelector('.new-item-unit');

        const itemId = parseInt(itemSelect.value);
        const quantity = parseInt(itemQuantity.value);

        // Collect item data
        const itemData = {
            item_id: itemId,
            quantity: quantity
        };

        if (itemId === -1) {
            itemData.item_name = newItemName.value.trim();
            itemData.item_category_id = parseInt(newItemCategory.value);
            itemData.item_unit = newItemUnit.value.trim() || 'pcs';
        }

        itemsData.push(itemData);
    }

    // Add items data as hidden fields
    for (let itemData of itemsData) {
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'items';
        hiddenField.value = JSON.stringify(itemData);
        form.appendChild(hiddenField);
    }

    // Clear draft after successful submission
    clearDraft();
    hasChanges = false;

    // Disable submit button to prevent double submission
    const submitBtn = document.querySelector('button[onclick="submitForm()"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
    }

    // Submit the form
    form.submit();
}

// Close modal on outside click
document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeConfirmModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeConfirmModal();
    }
});
</script>
{% endblock %}
