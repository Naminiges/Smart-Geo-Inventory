{% extends "base.html" %}

{% block title %}Permohonan Pengadaan Unit - Smart Geo Inventory{% endblock %}

{% block page_title %}Permohonan Pengadaan Unit{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">Daftar Permohonan Pengadaan</h1>
        <p class="text-gray-500 text-sm mt-1">Unit: {{ unit.name }}</p>
    </div>
    <a href="{{ url_for('unit_procurement.create_request') }}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
        <i class="fas fa-plus mr-2"></i>
        Buat Permohonan Baru
    </a>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
        <div class="text-sm text-gray-500">Total</div>
        <div class="text-2xl font-bold text-gray-800">{{ stats.total }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
        <div class="text-sm text-gray-500">Menunggu Verifikasi</div>
        <div class="text-2xl font-bold text-gray-800">{{ stats.pending }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
        <div class="text-sm text-gray-500">Terverifikasi</div>
        <div class="text-2xl font-bold text-gray-800">{{ stats.verified }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-indigo-500">
        <div class="text-sm text-gray-500">Dalam Proses</div>
        <div class="text-2xl font-bold text-gray-800">{{ stats.in_procurement }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-cyan-500">
        <div class="text-sm text-gray-500">Diterima</div>
        <div class="text-2xl font-bold text-gray-800">{{ stats.received }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
        <div class="text-sm text-gray-500">Selesai</div>
        <div class="text-2xl font-bold text-gray-800">{{ stats.completed }}</div>
    </div>
</div>

<!-- Filter -->
<div class="bg-white rounded-lg shadow mb-6 p-4">
    <form method="GET" class="flex items-center gap-4">
        <label class="text-sm font-semibold text-gray-700">Filter Status:</label>
        <select name="status" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">Semua Status</option>
            <option value="pending_verification" {% if current_filter == 'pending_verification' %}selected{% endif %}>Menunggu Verifikasi</option>
            <option value="verified" {% if current_filter == 'verified' %}selected{% endif %}>Terverifikasi</option>
            <option value="approved" {% if current_filter == 'approved' %}selected{% endif %}>Disetujui</option>
            <option value="in_procurement" {% if current_filter == 'in_procurement' %}selected{% endif %}>Dalam Proses Pengadaan</option>
            <option value="received" {% if current_filter == 'received' %}selected{% endif %}>Barang Diterima</option>
            <option value="completed" {% if current_filter == 'completed' %}selected{% endif %}>Selesai</option>
            <option value="rejected" {% if current_filter == 'rejected' %}selected{% endif %}>Ditolak</option>
            <option value="cancelled" {% if current_filter == 'cancelled' %}selected{% endif %}>Dibatalkan</option>
        </select>
        <button type="submit" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
            <i class="fas fa-filter mr-1"></i>
            Filter
        </button>
        {% if current_filter %}
        <a href="{{ url_for('unit_procurement.index') }}" class="text-red-600 hover:text-red-800 text-sm">
            <i class="fas fa-times mr-1"></i>
            Reset
        </a>
        {% endif %}
    </form>
</div>

<!-- Procurements List -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 paginated-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengadaan Warehouse</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if procurements %}
                    {% for procurement in procurements %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            #{{ procurement.id }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ procurement.created_at.strftime('%d/%m/%Y') }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div class="text-xs text-gray-500 mb-1">{{ procurement.items|length }} item(s)</div>
                            {% for item in procurement.items[:2] %}
                            <div class="text-xs">{{ item.item.name if item.item else 'N/A' }} ({{ item.quantity }})</div>
                            {% endfor %}
                            {% if procurement.items|length > 2 %}
                            <div class="text-xs text-gray-400">+{{ procurement.items|length - 2 }} lainnya</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set status_colors = {
                                'pending_verification': 'bg-yellow-100 text-yellow-800',
                                'verified': 'bg-purple-100 text-purple-800',
                                'approved': 'bg-blue-100 text-blue-800',
                                'in_procurement': 'bg-indigo-100 text-indigo-800',
                                'received': 'bg-cyan-100 text-cyan-800',
                                'completed': 'bg-green-100 text-green-800',
                                'rejected': 'bg-red-100 text-red-800',
                                'cancelled': 'bg-gray-100 text-gray-800'
                            } %}
                            {% set status_labels = {
                                'pending_verification': 'Menunggu Verifikasi',
                                'verified': 'Terverifikasi',
                                'approved': 'Disetujui',
                                'in_procurement': 'Dalam Proses',
                                'received': 'Diterima',
                                'completed': 'Selesai',
                                'rejected': 'Ditolak',
                                'cancelled': 'Dibatalkan'
                            } %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full {{ status_colors.get(procurement.status, 'bg-gray-100 text-gray-800') }}">
                                {{ status_labels.get(procurement.status, procurement.status) }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if procurement.procurement_id %}
                            <a href="{{ url_for('procurement.detail', id=procurement.procurement_id) }}" class="text-blue-600 hover:text-blue-800" target="_blank">
                                #{{ procurement.procurement_id }}
                                <i class="fas fa-external-link-alt text-xs ml-1"></i>
                            </a>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <a href="{{ url_for('unit_procurement.detail', id=procurement.id) }}" class="text-blue-600 hover:text-blue-800 mr-3">
                                <i class="fas fa-eye"></i> Detail
                            </a>
                            {% if procurement.status in ['pending_verification', 'verified'] %}
                            <form method="POST" action="{{ url_for('unit_procurement.cancel', id=procurement.id) }}" class="inline" onsubmit="return confirm('Yakin ingin membatalkan permohonan ini?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-times"></i> Batalkan
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                                <p class="text-gray-500 text-lg">Belum ada permohonan pengadaan</p>
                                <a href="{{ url_for('unit_procurement.create_request') }}" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    Buat Permohonan Pertama
                                </a>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
