{% extends "base.html" %}

{% block title %}Detail Distribusi #{{ distribution.id }} - Smart Geo Inventory{% endblock %}

{% block page_title %}Detail Distribusi #{{ distribution.id }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="max-w-4xl mx-auto">
        <!-- Back Button -->
        <div class="mb-4">
            <a href="{{ url_for('installations.index') }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Kembali ke Daftar
            </a>
        </div>

        <!-- Draft Warning Banner -->
        {% if distribution.is_draft %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
            <div class="flex items-start">
                <div class="bg-yellow-100 rounded-lg p-2 mr-4">
                    <i class="fas fa-file-alt text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <h4 class="font-semibold text-yellow-900 mb-2">Draft Distribusi</h4>
                    <p class="text-sm text-yellow-800">
                        Ini adalah draft distribusi yang menunggu verifikasi admin.
                        {% if current_user.is_admin() %}
                        Silakan verifikasi draft ini untuk melanjutkan distribusi.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Main Info Card -->
        <div class="bg-white rounded-xl shadow-md mb-6">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-archive text-emerald-600 mr-2"></i>
                            Distribusi #{{ distribution.id }}
                        </h3>
                        <p class="text-gray-600 mt-1">
                            {{ distribution.item_detail.item.name if distribution.item_detail and distribution.item_detail.item else '-' }}
                        </p>
                    </div>
                    <div>
                        {% if distribution.is_draft %}
                        <span class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-full font-semibold">
                            Draft
                        </span>
                        {% elif distribution.status == 'installing' %}
                        <span class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full font-semibold">
                            <i class="fas fa-truck mr-2"></i> Sedang Distribusi
                        </span>
                        {% elif distribution.status == 'in_transit' %}
                        <span class="px-4 py-2 bg-purple-100 text-purple-700 rounded-full font-semibold">
                            <i class="fas fa-shipping-fast mr-2"></i> Dalam Perjalanan
                        </span>
                        {% elif distribution.status == 'installed' %}
                        <span class="px-4 py-2 bg-green-100 text-green-700 rounded-full font-semibold">
                            <i class="fas fa-check-circle mr-2"></i> Selesai
                        </span>
                        {% elif distribution.status == 'rejected' %}
                        <span class="px-4 py-2 bg-red-100 text-red-700 rounded-full font-semibold">
                            <i class="fas fa-times-circle mr-2"></i> Ditolak
                        </span>
                        {% else %}
                        <span class="px-4 py-2 bg-gray-100 text-gray-700 rounded-full font-semibold">
                            {{ distribution.status }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Item Information -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-4">
                            <i class="fas fa-box text-emerald-600 mr-2"></i>Informasi Barang
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <span class="text-gray-500 text-sm">Serial Number:</span>
                                <p class="font-semibold text-blue-600">{{ distribution.item_detail.serial_number if distribution.item_detail else '-' }}</p>
                            </div>
                            <div>
                                <span class="text-gray-500 text-sm">Serial Unit:</span>
                                <p class="font-medium">{{ distribution.item_detail.serial_unit or '-' }}</p>
                            </div>
                            <div>
                                <span class="text-gray-500 text-sm">Nama Barang:</span>
                                <p class="font-medium">{{ distribution.item_detail.item.name if distribution.item_detail and distribution.item_detail.item else '-' }}</p>
                            </div>
                            <div>
                                <span class="text-gray-500 text-sm">Kategori:</span>
                                <p class="font-medium">{{ distribution.item_detail.item.category.name if distribution.item_detail and distribution.item_detail.item and distribution.item_detail.item.category else '-' }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Destination Information -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-4">
                            <i class="fas fa-map-marker-alt text-emerald-600 mr-2"></i>Informasi Tujuan
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <span class="text-gray-500 text-sm">Unit:</span>
                                <p class="font-semibold">{{ distribution.unit.name if distribution.unit else '-' }}</p>
                            </div>
                            {% if distribution.unit_detail %}
                            <div>
                                <span class="text-gray-500 text-sm">Ruangan:</span>
                                <p class="font-medium">{{ distribution.unit_detail.room_name }}</p>
                            </div>
                            {% if distribution.unit_detail.floor %}
                            <div>
                                <span class="text-gray-500 text-sm">Lantai:</span>
                                <p class="font-medium">{{ distribution.unit_detail.floor }}</p>
                            </div>
                            {% endif %}
                            {% endif %}
                            <div>
                                <span class="text-gray-500 text-sm">Alamat:</span>
                                <p class="font-medium text-gray-800">{{ distribution.address }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Info Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Warehouse Info -->
            <div class="bg-white rounded-xl shadow-md">
                <div class="p-6 border-b border-gray-200">
                    <h4 class="font-semibold text-gray-800">
                        <i class="fas fa-warehouse text-emerald-600 mr-2"></i>Warehouse Asal
                    </h4>
                </div>
                <div class="p-6">
                    <p class="font-medium text-lg">{{ distribution.warehouse.name if distribution.warehouse else '-' }}</p>
                    <p class="text-gray-600 text-sm">{{ distribution.warehouse.address if distribution.warehouse else '' }}</p>
                </div>
            </div>

            <!-- Staff/Creator Info -->
            <div class="bg-white rounded-xl shadow-md">
                <div class="p-6 border-b border-gray-200">
                    <h4 class="font-semibold text-gray-800">
                        <i class="fas fa-user text-emerald-600 mr-2"></i>
                        {% if distribution.is_draft %}Pembuat Draft{% else %}Field Staff{% endif %}
                    </h4>
                </div>
                <div class="p-6">
                    {% if distribution.is_draft %}
                        <p class="font-medium text-lg">{{ distribution.draft_creator.name if distribution.draft_creator else '-' }}</p>
                        <p class="text-gray-600 text-sm">{{ distribution.draft_creator.email if distribution.draft_creator else '' }}</p>
                    {% else %}
                        <p class="font-medium text-lg">{{ distribution.field_staff.name if distribution.field_staff else '-' }}</p>
                        <p class="text-gray-600 text-sm">{{ distribution.field_staff.email if distribution.field_staff else '' }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        {% if distribution.draft_notes or distribution.note %}
        <div class="bg-white rounded-xl shadow-md mb-6">
            <div class="p-6 border-b border-gray-200">
                <h4 class="font-semibold text-gray-800">
                    <i class="fas fa-sticky-note text-emerald-600 mr-2"></i>Catatan
                </h4>
            </div>
            <div class="p-6">
                <p class="text-gray-700">{{ distribution.draft_notes or distribution.note or '-' }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Timeline -->
        <div class="bg-white rounded-xl shadow-md mb-6">
            <div class="p-6 border-b border-gray-200">
                <h4 class="font-semibold text-gray-800">
                    <i class="fas fa-history text-emerald-600 mr-2"></i>Timeline
                </h4>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mt-1.5 mr-4 flex-shrink-0"></div>
                        <div>
                            <p class="font-semibold text-gray-800">Dibuat</p>
                            <p class="text-sm text-gray-600">{{ distribution.created_at.strftime('%d %B %Y, %H:%M') }}</p>
                        </div>
                    </div>
                    {% if distribution.draft_verified_at %}
                    <div class="flex">
                        <div class="w-3 h-3 bg-green-500 rounded-full mt-1.5 mr-4 flex-shrink-0"></div>
                        <div>
                            <p class="font-semibold text-gray-800">Diverifikasi</p>
                            <p class="text-sm text-gray-600">{{ distribution.draft_verified_at.strftime('%d %B %Y, %H:%M') }} oleh {{ distribution.draft_verifier.name if distribution.draft_verifier else '-' }}</p>
                        </div>
                    </div>
                    {% endif %}
                    {% if distribution.installed_at %}
                    <div class="flex">
                        <div class="w-3 h-3 bg-purple-500 rounded-full mt-1.5 mr-4 flex-shrink-0"></div>
                        <div>
                            <p class="font-semibold text-gray-800">Distribusi</p>
                            <p class="text-sm text-gray-600">{{ distribution.installed_at.strftime('%d %B %Y, %H:%M') }}</p>
                        </div>
                    </div>
                    {% endif %}
                    <div class="flex">
                        <div class="w-3 h-3 bg-gray-400 rounded-full mt-1.5 mr-4 flex-shrink-0"></div>
                        <div>
                            <p class="font-semibold text-gray-800">Terakhir Diupdate</p>
                            <p class="text-sm text-gray-600">{{ distribution.updated_at.strftime('%d %B %Y, %H:%M') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-xl shadow-md">
            <div class="p-6 border-b border-gray-200">
                <h4 class="font-semibold text-gray-800">
                    <i class="fas fa-bolt text-emerald-600 mr-2"></i>Aksi
                </h4>
            </div>
            <div class="p-6">
                <div class="flex flex-wrap gap-3">
                    {% if distribution.is_draft and current_user.is_admin() %}
                    <a href="{{ url_for('installations.verify_general_distribution', id=distribution.id) }}" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        <i class="fas fa-check-circle mr-2"></i> Verifikasi Draft
                    </a>
                    {% elif not distribution.is_draft and distribution.status == 'installing' %}
                    <a href="{{ url_for('installations.update_status', id=distribution.id, status='installed') }}" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        <i class="fas fa-check-circle mr-2"></i> Tandai Selesai
                    </a>
                    {% endif %}
                    <a href="{{ url_for('map.index', show='distributions') }}" class="px-6 py-3 border border-purple-600 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white transition-colors font-semibold">
                        <i class="fas fa-map mr-2"></i> Lihat di Peta
                    </a>
                </div>
            </div>
        </div>

        <!-- Rejection Reason -->
        {% if distribution.draft_rejection_reason %}
        <div class="bg-red-50 border border-red-200 rounded-xl p-6 mt-6">
            <h4 class="font-semibold text-red-900 mb-2">
                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>Alasan Penolakan
            </h4>
            <p class="text-red-800">{{ distribution.draft_rejection_reason }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
