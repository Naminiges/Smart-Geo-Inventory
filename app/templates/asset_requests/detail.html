{% extends "base.html" %}

{% block title %}Detail Permohonan #{{ asset_request.id }} - Smart Geo Inventory{% endblock %}

{% block page_title %}Detail Permohonan Aset{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-4">
    <a href="{{ url_for('asset_requests.index') }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali ke Daftar Permohonan
    </a>
</div>

<!-- Status Banner -->
{% set status_colors = {
    'pending': 'bg-yellow-100 border-yellow-300 text-yellow-800',
    'verified': 'bg-indigo-100 border-indigo-300 text-indigo-800',
    'distributing': 'bg-blue-100 border-blue-300 text-blue-800',
    'processing': 'bg-blue-100 border-blue-300 text-blue-800',
    'completed': 'bg-green-100 border-green-300 text-green-800',
    'rejected': 'bg-red-100 border-red-300 text-red-800'
} %}
{% set status_labels = {
    'pending': 'Menunggu Verifikasi',
    'verified': 'Terverifikasi',
    'distributing': 'Sedang Didistribusikan',
    'processing': 'Sedang Diproses',
    'completed': 'Selesai',
    'rejected': 'Ditolak'
} %}
<div class="mb-6 p-4 rounded-lg border {{ status_colors.get(asset_request.status, 'bg-gray-100 border-gray-300 text-gray-800') }}">
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center">
            <i class="fas fa-info-circle text-2xl mr-3"></i>
            <div>
                <h3 class="text-lg font-semibold">Status: {{ status_labels.get(asset_request.status, asset_request.status) }}</h3>
                <p class="text-sm opacity-75">Permohonan #{{ asset_request.id }} dari Unit: {{ asset_request.unit.name if asset_request.unit else '-' }}</p>
            </div>
        </div>
        <div class="flex gap-2">
            {% if asset_request.status == 'pending' and current_user.is_admin() %}
            <a href="{{ url_for('asset_requests.verify', id=asset_request.id) }}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                <i class="fas fa-check mr-2"></i>Verifikasi
            </a>
            <button type="button" onclick="toggleRejectModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-times mr-2"></i>Tolak
            </button>
            {% endif %}
            {% if asset_request.status == 'verified' and (current_user.is_warehouse_staff() or current_user.is_admin()) %}
            <a href="{{ url_for('asset_requests.distribute', id=asset_request.id) }}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-truck mr-2"></i>Proses Distribusi
            </a>
            {% endif %}
            {% if asset_request.status == 'distributing' and current_user.is_unit_staff() %}
            <div class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg">
                <i class="fas fa-truck mr-2"></i>Barang sedang didistribusikan
            </div>
            {% endif %}
            {% if asset_request.status == 'verified' and current_user.is_unit_staff() %}
            {% if asset_request.distribution_id %}
            <a href="{{ url_for('asset_requests.confirm_receipt', id=asset_request.id) }}" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-check-circle mr-2"></i>Tandai Selesai
            </a>
            {% else %}
            <div class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg">
                <i class="fas fa-clock mr-2"></i>Menunggu distribusi
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Request Information -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
            Informasi Permohonan
        </h3>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">ID Permohonan</span>
                <span class="text-sm font-semibold text-gray-900">#{{ asset_request.id }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Unit</span>
                <span class="text-sm font-semibold text-gray-900">{{ asset_request.unit.name if asset_request.unit else '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Tanggal Permohonan</span>
                <span class="text-sm font-semibold text-gray-900">{{ format_wib_datetime(asset_request.request_date, '%d/%m/%Y %H:%M') }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Diajukan oleh</span>
                <span class="text-sm font-semibold text-gray-900">{{ asset_request.requester.name if asset_request.requester else '-' }}</span>
            </div>
            {% if asset_request.verified_by %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Diverifikasi oleh</span>
                <span class="text-sm font-semibold text-gray-900">{{ asset_request.verifier.name if asset_request.verifier else '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Tanggal Verifikasi</span>
                <span class="text-sm font-semibold text-gray-900">{{ format_wib_datetime(asset_request.verified_at, '%d/%m/%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if asset_request.received_by %}
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Diterima oleh</span>
                <span class="text-sm font-semibold text-gray-900">{{ asset_request.receiver.name if asset_request.receiver else '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-sm text-gray-500">Tanggal Penerimaan</span>
                <span class="text-sm font-semibold text-gray-900">{{ format_wib_datetime(asset_request.received_at, '%d/%m/%Y %H:%M') }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Requested Items -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-boxes text-green-600 mr-2"></i>
            Aset yang Dimohonkan ({{ asset_request.items|length }} item)
        </h3>
        <div class="space-y-3 max-h-80 overflow-y-auto">
            {% for item in asset_request.items %}
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start justify-between mb-2">
                    <div>
                        <p class="text-sm font-semibold text-gray-900">{{ item.item.name if item.item else '-' }}</p>
                        <p class="text-xs text-gray-500">Kategori: {{ item.item.category.name if item.item and item.item.category else '-' }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-900">{{ item.quantity }}</p>
                        <p class="text-xs text-gray-500">unit</p>
                    </div>
                </div>
                {% if item.unit_detail %}
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Lokasi: {{ item.unit_detail.room_name }} ({{ item.unit_detail.floor }})
                    </p>
                    {% if item.room_notes %}
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-sticky-note mr-1"></i>
                        {{ item.room_notes }}
                    </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Notes Section -->
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Catatan & Informasi</h3>

    <!-- Request Notes -->
    {% if asset_request.request_notes %}
    <div class="mb-4">
        <h4 class="text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-comment-alt text-amber-600 mr-1"></i>
            Alasan Permohonan
        </h4>
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
            <p class="text-sm text-gray-700">{{ asset_request.request_notes }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Verification Notes -->
    {% if asset_request.verification_notes %}
    <div class="mb-4">
        <h4 class="text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-clipboard-check text-indigo-600 mr-1"></i>
            Catatan Verifikasi
        </h4>
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
            <p class="text-sm text-gray-700">{{ asset_request.verification_notes }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Additional Notes -->
    {% if asset_request.notes %}
    <div class="mb-0">
        <h4 class="text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-sticky-note text-blue-600 mr-1"></i>
            Catatan Tambahan
        </h4>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <p class="text-sm text-gray-700">{{ asset_request.notes }}</p>
        </div>
    </div>
    {% endif %}

    {% if not asset_request.request_notes and not asset_request.verification_notes and not asset_request.notes %}
    <p class="text-sm text-gray-500 italic">Tidak ada catatan tambahan.</p>
    {% endif %}
</div>

<!-- Status Information -->
<div class="bg-white rounded-xl shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Status & Progress</h3>

    <!-- Timeline -->
    <div class="space-y-4">
        <!-- Step 1: Request Created -->
        <div class="flex items-start">
            <div class="flex flex-col items-center mr-4">
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                    <i class="fas fa-file-alt text-green-600"></i>
                </div>
                {% if asset_request.verified_at or asset_request.distributed_at or asset_request.received_at %}
                <div class="w-0.5 h-16 bg-green-200 mt-2"></div>
                {% endif %}
            </div>
            <div class="flex-1">
                <p class="font-semibold text-gray-900">Permohonan Dibuat</p>
                <p class="text-sm text-gray-600">{{ format_wib_datetime(asset_request.request_date) }}</p>
                <p class="text-xs text-gray-500">oleh {{ asset_request.requester.name if asset_request.requester else '-' }}</p>
            </div>
        </div>

        <!-- Step 2: Verified -->
        <div class="flex items-start {% if not asset_request.verified_at %}opacity-50{% endif %}">
            <div class="flex flex-col items-center mr-4">
                <div class="w-10 h-10 rounded-full {% if asset_request.verified_at %}bg-green-100{% else %}bg-gray-100{% endif %} flex items-center justify-center">
                    <i class="fas fa-check-circle {% if asset_request.verified_at %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                </div>
                {% if asset_request.distributed_at or asset_request.received_at %}
                <div class="w-0.5 h-16 bg-green-200 mt-2"></div>
                {% endif %}
            </div>
            <div class="flex-1">
                <p class="font-semibold text-gray-900">Diverifikasi Admin</p>
                {% if asset_request.verified_at %}
                <p class="text-sm text-gray-600">{{ format_wib_datetime(asset_request.verified_at) }}</p>
                <p class="text-xs text-gray-500">oleh {{ asset_request.verifier.name if asset_request.verifier else '-' }}</p>
                {% else %}
                <p class="text-sm text-gray-400">Menunggu verifikasi</p>
                {% endif %}
            </div>
        </div>

        <!-- Step 3: Distributed -->
        <div class="flex items-start {% if not asset_request.distributed_at %}opacity-50{% endif %}">
            <div class="flex flex-col items-center mr-4">
                <div class="w-10 h-10 rounded-full {% if asset_request.distributed_at %}bg-green-100{% else %}bg-gray-100{% endif %} flex items-center justify-center">
                    <i class="fas fa-truck {% if asset_request.distributed_at %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                </div>
                {% if asset_request.received_at %}
                <div class="w-0.5 h-16 bg-green-200 mt-2"></div>
                {% endif %}
            </div>
            <div class="flex-1">
                <p class="font-semibold text-gray-900">Didistribusikan</p>
                {% if asset_request.distributed_at %}
                <p class="text-sm text-gray-600">{{ format_wib_datetime(asset_request.distributed_at) }}</p>
                <p class="text-xs text-gray-500">oleh {{ asset_request.distributor.name if asset_request.distributor else '-' }}</p>
                {% if asset_request.distribution_id %}
                <a href="{{ url_for('installations.detail', id=asset_request.distribution_id) }}" target="_blank" class="text-xs text-blue-600 hover:underline">Lihat Distribusi #{{ asset_request.distribution_id }}</a>
                {% endif %}
                {% else %}
                <p class="text-sm text-gray-400">Menunggu distribusi</p>
                {% endif %}
            </div>
        </div>

        <!-- Step 4: Received/Completed -->
        <div class="flex items-start {% if not asset_request.received_at %}opacity-50{% endif %}">
            <div class="flex flex-col items-center mr-4">
                <div class="w-10 h-10 rounded-full {% if asset_request.received_at %}bg-green-100{% else %}bg-gray-100{% endif %} flex items-center justify-center">
                    <i class="fas fa-check-double {% if asset_request.received_at %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                </div>
            </div>
            <div class="flex-1">
                <p class="font-semibold text-gray-900">Diterima</p>
                {% if asset_request.received_at %}
                <p class="text-sm text-gray-600">{{ format_wib_datetime(asset_request.received_at) }}</p>
                <p class="text-xs text-gray-500">oleh {{ asset_request.receiver.name if asset_request.receiver else '-' }}</p>

                <!-- Proof Photo -->
                <div class="mt-3">
                    <button onclick="toggleProofPhoto()" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center">
                        <i class="fas fa-camera mr-1"></i>
                        <span id="photoToggleText">Lihat Bukti Foto</span>
                    </button>
                    <div id="proofPhotoContainer" class="hidden mt-3">
                        <img src="{{ url_for('asset_requests.proof_photo', id=asset_request.id) }}"
                             alt="Bukti Penerimaan"
                             class="max-w-md rounded-lg border border-gray-300 shadow-md"
                             onerror="this.parentElement.innerHTML='<div class=\'p-4 bg-gray-100 rounded-lg text-gray-500 text-center\'><i class=\'fas fa-image text-4xl mb-2\'></i><p class=\'text-sm\'>Foto tidak tersedia</p></div>'">
                    </div>
                </div>
                {% else %}
                <p class="text-sm text-gray-400">Menunggu konfirmasi penerimaan</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Current Status Banner -->
    <div class="mt-6 pt-6 border-t border-gray-200">

    {% if asset_request.status == 'pending' %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-clock text-yellow-600 text-xl mr-3 mt-1"></i>
            <div>
                <h4 class="font-semibold text-yellow-900">Menunggu Verifikasi</h4>
                <p class="text-sm text-yellow-800 mt-1">
                    {% if current_user.is_admin() %}
                    Permohonan ini menunggu verifikasi dari Anda. Silakan review dan verifikasi permohonan ini.
                    {% else %}
                    Permohonan ini menunggu verifikasi dari admin.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% elif asset_request.status == 'distributing' %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-truck text-blue-600 text-xl mr-3 mt-1"></i>
            <div class="flex-1">
                <h4 class="font-semibold text-blue-900">Sedang Didistribusikan</h4>
                <p class="text-sm text-blue-800 mt-1">
                    {% if current_user.is_unit_staff() %}
                    Permohonan sedang dalam proses distribusi oleh warehouse staff. Barang sedang dikirim ke lokasi Anda.
                    {% if asset_request.distribution_id %}
                    <br><a href="{{ url_for('installations.detail', id=asset_request.distribution_id) }}" target="_blank" class="underline font-semibold">Lihat Distribusi #{{ asset_request.distribution_id }}</a>
                    {% endif %}
                    {% elif current_user.is_warehouse_staff() or current_user.is_admin() %}
                    Permohonan sedang didistribusikan ke unit.
                    {% if asset_request.distribution_id %}
                    <br><a href="{{ url_for('installations.detail', id=asset_request.distribution_id) }}" target="_blank" class="underline font-semibold">Lihat Distribusi #{{ asset_request.distribution_id }}</a>
                    {% endif %}
                    {% endif %}
                </p>

                {% if current_user.is_unit_staff() %}
                <a href="{{ url_for('asset_requests.confirm_receipt', id=asset_request.id) }}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold mt-4">
                    <i class="fas fa-check-circle mr-2"></i>
                    Konfirmasi Penerimaan Barang
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif asset_request.status == 'verified' %}
    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-check-circle text-indigo-600 text-xl mr-3 mt-1"></i>
            <div>
                <h4 class="font-semibold text-indigo-900">Terverifikasi</h4>
                <p class="text-sm text-indigo-800 mt-1">
                    {% if current_user.is_unit_staff() %}
                    Permohonan sudah diverifikasi. Menunggu proses distribusi dari warehouse staff.
                    {% if asset_request.distribution_id %}
                    <br><a href="{{ url_for('installations.detail', id=asset_request.distribution_id) }}" target="_blank" class="underline font-semibold">Lihat Distribusi #{{ asset_request.distribution_id }}</a>
                    {% endif %}
                    {% elif current_user.is_warehouse_staff() or current_user.is_admin() %}
                    Permohonan sudah diverifikasi dan siap untuk didistribusikan. Silakan klik tombol "Proses Distribusi" untuk membuat distribusi.
                    {% else %}
                    Permohonan sudah diverifikasi dan siap untuk didistribusikan.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% elif asset_request.status == 'completed' %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-check-double text-green-600 text-xl mr-3 mt-1"></i>
            <div>
                <h4 class="font-semibold text-green-900">Selesai</h4>
                <p class="text-sm text-green-800 mt-1">Permohonan ini sudah selesai. Semua aset telah diterima oleh unit.</p>
            </div>
        </div>
    </div>
    {% elif asset_request.status == 'rejected' %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start">
            <i class="fas fa-times-circle text-red-600 text-xl mr-3 mt-1"></i>
            <div>
                <h4 class="font-semibold text-red-900">Ditolak</h4>
                <p class="text-sm text-red-800 mt-1">Permohonan ini ditolak oleh admin.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Reject Modal -->
{% if current_user.is_admin() and asset_request.status == 'pending' %}
<div id="rejectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
        <form method="POST" action="{{ url_for('asset_requests.reject', id=asset_request.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Tolak Permohonan</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="rejection_reason" class="block text-sm font-semibold text-gray-700 mb-2">
                        Alasan Penolakan <span class="text-red-600">*</span>
                    </label>
                    <textarea class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" id="rejection_reason" name="rejection_reason" rows="4" required placeholder="Jelaskan mengapa permohonan ini ditolak..."></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button type="button" onclick="toggleRejectModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Batal
                </button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    <i class="fas fa-times mr-2"></i>Tolak Permohonan
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
function toggleRejectModal() {
    const modal = document.getElementById('rejectModal');
    if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

function toggleProofPhoto() {
    const container = document.getElementById('proofPhotoContainer');
    const toggleText = document.getElementById('photoToggleText');

    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        toggleText.textContent = 'Sembunyikan Bukti Foto';
    } else {
        container.classList.add('hidden');
        toggleText.textContent = 'Lihat Bukti Foto';
    }
}
</script>
{% endblock %}
