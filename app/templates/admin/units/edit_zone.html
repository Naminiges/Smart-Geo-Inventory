{% extends "base.html" %}

{% block title %}Edit Zona - {{ unit.name }} - Smart Geo Inventory{% endblock %}

{% block page_title %}Edit Zona Spasial{% endblock %}

{% block extra_css %}
<style>
    #zoneMap {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        cursor: crosshair;
    }
    .zone-instructions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        padding: 16px;
        color: white;
        margin-bottom: 16px;
    }
    .marker-info {
        display: inline-block;
        padding: 4px 12px;
        background: rgba(255,255,255,0.2);
        border-radius: 20px;
        margin: 4px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Back Button -->
<div class="mb-4">
    <a href="{{ url_for('units.index') }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Kembali ke Daftar Unit
    </a>
</div>

<!-- Edit Zone Form -->
<div class="bg-white rounded-xl shadow-md">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">
            <i class="fas fa-draw-polygon mr-2 text-purple-600"></i>
            Edit Zona: {{ unit.name }}
        </h3>
        <p class="text-sm text-gray-600 mt-1">Definisikan atau update zona spasial untuk unit ini</p>
    </div>

    <form method="POST" id="zoneForm" class="p-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="zone_coordinates" id="zone_coordinates">
        <input type="hidden" name="zone_kode" id="zone_kode">
        <input type="hidden" name="zone_deskripsi" id="zone_deskripsi">

        <!-- Unit Info (Read-only) -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="text-md font-semibold text-gray-800 mb-2">Informasi Unit</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <span class="text-sm text-gray-500">Nama Unit:</span>
                    <p class="font-semibold text-gray-800">{{ unit.name }}</p>
                </div>
                <div>
                    <span class="text-sm text-gray-500">Status:</span>
                    <p class="font-semibold text-gray-800">{{ unit.status|title }}</p>
                </div>
            </div>
            <div class="mt-2">
                <span class="text-sm text-gray-500">Alamat:</span>
                <p class="text-sm text-gray-700">{{ unit.address }}</p>
            </div>
        </div>

        <!-- Zone Definition -->
        <div class="mb-6">
            <h4 class="text-md font-semibold text-gray-800 mb-4">
                <i class="fas fa-draw-polygon mr-2 text-purple-600"></i>
                Definisi Zona Spasial
            </h4>

            <!-- Instructions -->
            <div class="zone-instructions">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-2xl mr-3 mt-1"></i>
                    <div>
                        <h5 class="font-bold text-lg mb-2">Cara Edit/Definisi Zona:</h5>
                        <ol class="list-decimal list-inside space-y-1 text-sm">
                            <li>Klik di peta untuk menambahkan titik pembatas zona</li>
                            <li>Klik minimal 3 titik untuk membentuk polygon</li>
                            <li>Tambahkan titik sebanyak yang dibutuhkan</li>
                            <li>Polygon akan otomatis tertutup (titik terakhir kembali ke titik awal)</li>
                        </ol>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <span class="marker-info" id="markerCount">0 titik diklik (min. 3)</span>
                            <span class="marker-info" id="zoneStatus" style="display:none;">Zona siap disimpan!</span>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button type="button" onclick="undoLastMarker()" class="px-4 py-2 bg-orange-600 bg-opacity-20 hover:bg-opacity-30 rounded-lg text-sm font-semibold">
                                <i class="fas fa-undo mr-1"></i> Undo Terakhir
                            </button>
                            <button type="button" onclick="resetMarkers()" class="px-4 py-2 bg-red-600 bg-opacity-20 hover:bg-opacity-30 rounded-lg text-sm font-semibold">
                                <i class="fas fa-redo mr-1"></i> Reset Semua
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="border border-gray-300 rounded-lg overflow-hidden">
                <div id="zoneMap"></div>
            </div>

            <!-- Zone Form -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Kode Zona</label>
                    <input type="text" id="kodeZona" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Contoh: Z-PSI-01">
                    <p class="text-xs text-gray-500 mt-1">Kode unik untuk identifikasi zona</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi Zona</label>
                    <input type="text" id="deskripsiZona" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Keterangan singkat tentang zona">
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
            <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                Klik minimal 3 titik di peta untuk membuat zona
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('units.index') }}" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                    <i class="fas fa-times mr-2"></i>Batal
                </a>
                <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                    <i class="fas fa-save mr-2"></i>Simpan Zona
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize map
var map = L.map('zoneMap').setView([3.561676, 98.6563423], 18);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
}).addTo(map);

// Variables for zone creation
var markers = [];
var polygonLayer = null;
var coordinates = [];

// Load existing zone if available
var existingZone = {{ unit.zone_json|safe if unit.zone_json else 'null' }};

if (existingZone) {
    var props = existingZone.properties;
    document.getElementById('kodeZona').value = props.kode_zona || '';
    document.getElementById('deskripsiZona').value = props.deskripsi || '';

    // Load existing coordinates
    if (existingZone.geometry && existingZone.geometry.coordinates && existingZone.geometry.coordinates[0]) {
        var coords = existingZone.geometry.coordinates[0];
        // Remove the last closing point
        if (coords.length > 0 && coords[0][0] === coords[coords.length-1][0] && coords[0][1] === coords[coords.length-1][1]) {
            coords = coords.slice(0, -1);
        }

        coords.forEach(function(coord) {
            var latlng = [coord[1], coord[0]];
            var marker = L.marker(latlng).addTo(map);
            markers.push(marker);
            coordinates.push([coord[0], coord[1]]);
        });

        document.getElementById('markerCount').textContent = markers.length + ' titik diklik';
        drawPolygon();
        document.getElementById('zoneStatus').style.display = 'inline-block';

        // Fit map to show the entire polygon
        if (polygonLayer) {
            map.fitBounds(polygonLayer.getBounds());
        }
    }
}

// Click handler for map
map.on('click', function(e) {
    // Add marker
    var marker = L.marker(e.latlng).addTo(map);
    markers.push(marker);
    coordinates.push([e.latlng.lng, e.latlng.lat]);

    // Update marker count
    document.getElementById('markerCount').textContent = markers.length + ' titik diklik (min. 3)';

    // If we have at least 3 markers, show polygon
    if (markers.length >= 3) {
        drawPolygon();
        document.getElementById('zoneStatus').style.display = 'inline-block';
    } else if (markers.length >= 2) {
        // Draw line for 2 points
        drawPolygon();
    }
});

function drawPolygon() {
    // Remove existing polygon
    if (polygonLayer) {
        map.removeLayer(polygonLayer);
    }

    // Create coordinates array (close the polygon automatically by Leaflet)
    var latLngs = coordinates.map(function(coord) {
        return [coord[1], coord[0]];
    });

    // Draw polygon or line based on number of points
    if (markers.length >= 3) {
        polygonLayer = L.polygon(latLngs, {
            color: '#8b5cf6',
            weight: 3,
            fillColor: '#a78bfa',
            fillOpacity: 0.25
        }).addTo(map);
    } else if (markers.length === 2) {
        // Draw line for 2 points
        polygonLayer = L.polyline(latLngs, {
            color: '#8b5cf6',
            weight: 3,
            dashArray: '10, 10'
        }).addTo(map);
    }
}

function undoLastMarker() {
    if (markers.length === 0) {
        return;
    }

    // Remove last marker
    var lastMarker = markers.pop();
    map.removeLayer(lastMarker);
    coordinates.pop();

    // Update UI
    document.getElementById('markerCount').textContent = markers.length + ' titik diklik (min. 3)';

    // Redraw polygon
    if (polygonLayer) {
        map.removeLayer(polygonLayer);
        polygonLayer = null;
    }

    if (markers.length >= 2) {
        drawPolygon();
    }

    // Hide status if less than 3 points
    if (markers.length < 3) {
        document.getElementById('zoneStatus').style.display = 'none';
    }
}

function resetMarkers() {
    // Remove all markers
    markers.forEach(function(marker) {
        map.removeLayer(marker);
    });
    markers = [];
    coordinates = [];

    // Remove polygon
    if (polygonLayer) {
        map.removeLayer(polygonLayer);
        polygonLayer = null;
    }

    // Reset UI
    document.getElementById('markerCount').textContent = '0 titik diklik (min. 3)';
    document.getElementById('zoneStatus').style.display = 'none';
}

// Form submit handler - populate zone data before submit
document.getElementById('zoneForm').addEventListener('submit', function(e) {
    if (markers.length >= 3) {
        var kodeZona = document.getElementById('kodeZona').value;
        var deskripsi = document.getElementById('deskripsiZona').value;

        // Close the polygon coordinates
        var closedCoords = coordinates.slice();
        closedCoords.push(coordinates[0]);

        // Populate hidden fields
        document.getElementById('zone_kode').value = kodeZona || '';
        document.getElementById('zone_deskripsi').value = deskripsi || '';
        document.getElementById('zone_coordinates').value = JSON.stringify(closedCoords);
    } else {
        // Confirm if user wants to submit without zone
        if (!confirm('Anda belum membuat zona (minimal 3 titik). Lanjutkan simpan tanpa zona?')) {
            e.preventDefault();
            return false;
        }
        // Clear zone fields
        document.getElementById('zone_kode').value = '';
        document.getElementById('zone_deskripsi').value = '';
        document.getElementById('zone_coordinates').value = '';
    }
});
</script>
{% endblock %}
